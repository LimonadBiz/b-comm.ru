---
title: Скрипт для логгирования мак-адресов пользователей
author: wel
type: post
date: 2009-12-15T00:23:33+00:00
url: /billing/скрипт-для-логгирования-мак-адресов-п
short-url:
  - http://bit.ly/hmNALr
wp-syntax-cache-content:
  - |
    a:5:{i:1;s:891:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">*/</span><span style="color: #000000;">10</span>    <span style="color: #000000; font-weight: bold;">*</span>       <span style="color: #000000; font-weight: bold;">*</span>       <span style="color: #000000; font-weight: bold;">*</span>       <span style="color: #000000; font-weight: bold;">*</span>       root <span style="color: #000000; font-weight: bold;">/</span>arpwatch.sh  <span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>null</pre></td></tr></table><p class="theCode" style="display:none;">*/10    *       *       *       *       root /arpwatch.sh  &gt; /dev/null</p></div>
    ";i:2;s:9491:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    </pre></td><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/usr/local/bin/bash</span>
    <span style="color: #666666; font-style: italic;">#для моих реальников - начинаются с 91.203., но это не правильно)))</span>
    <span style="color: #666666; font-style: italic;">#тут надо было использовать egrep</span>
    <span style="color: #666666; font-style: italic;">#в общем не пишите так скрипты))) </span>
    <span style="color: #666666; font-style: italic;">#@www.isp.pl.ua</span>
    <span style="color: #666666; font-style: italic;">############</span>
    &nbsp;
    arp <span style="color: #660033;">-a</span> <span style="color: #660033;">-n</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">'('</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">')'</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{print$2&quot;K&quot;$4&quot;L&quot;}'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #000000;">10</span>. <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;incomplet&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;ff:ff&quot;</span><span style="color: #000000; font-weight: bold;">|</span><span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;91.203.&quot;</span><span style="color: #000000; font-weight: bold;">&gt;/</span>arpwatch.table
    &nbsp;
    arp <span style="color: #660033;">-a</span> <span style="color: #660033;">-n</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">'('</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">')'</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{print$2,$4}'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #000000;">10</span>. <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;incomplet&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;ff:ff&quot;</span><span style="color: #000000; font-weight: bold;">|</span><span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;91.203.&quot;</span><span style="color: #000000; font-weight: bold;">&gt;/</span>arpwatch.table
    &nbsp;
    arp <span style="color: #660033;">-a</span> <span style="color: #660033;">-n</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">'('</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">')'</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{print$2,$4}'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #000000;">10</span>. <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;incomplet&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;ff:ff&quot;</span><span style="color: #000000; font-weight: bold;">|</span><span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;91.203.&quot;</span><span style="color: #000000; font-weight: bold;">&gt;/</span>arpwatch.table
    arp <span style="color: #660033;">-a</span> <span style="color: #660033;">-n</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">'('</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">')'</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{print$2,$4}'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #ff0000;">&quot;172.168&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;incomplet&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;ff:ff&quot;</span><span style="color: #000000; font-weight: bold;">&gt;&gt;/</span>arpwatch.table
    arp <span style="color: #660033;">-a</span> <span style="color: #660033;">-n</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">'('</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">tr</span> <span style="color: #ff0000;">')'</span> <span style="color: #ff0000;">' '</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{print$2,$4}'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #ff0000;">&quot;91.&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;incomplet&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #660033;">-v</span> <span style="color: #ff0000;">&quot;ff:ff&quot;</span><span style="color: #000000; font-weight: bold;">&gt;&gt;/</span>arpwatch.table
    &nbsp;
    <span style="color: #000000; font-weight: bold;">/</span>arpwatch.php</pre></td></tr></table><p class="theCode" style="display:none;">#!/usr/local/bin/bash
    #для моих реальников - начинаются с 91.203., но это не правильно)))
    #тут надо было использовать egrep
    #в общем не пишите так скрипты))) 
    #@www.isp.pl.ua
    ############
    
    arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2&quot;K&quot;$4&quot;L&quot;}' | grep 10. | grep -v &quot;incomplet&quot; | grep -v &quot;ff:ff&quot;|grep -v &quot;91.203.&quot;&gt;/arpwatch.table
    
    arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep 10. | grep -v &quot;incomplet&quot; | grep -v &quot;ff:ff&quot;|grep -v &quot;91.203.&quot;&gt;/arpwatch.table
    
    arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep 10. | grep -v &quot;incomplet&quot; | grep -v &quot;ff:ff&quot;|grep -v &quot;91.203.&quot;&gt;/arpwatch.table
    arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep &quot;172.168&quot; | grep -v &quot;incomplet&quot; | grep -v &quot;ff:ff&quot;&gt;&gt;/arpwatch.table
    arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep &quot;91.&quot; | grep -v &quot;incomplet&quot; | grep -v &quot;ff:ff&quot;&gt;&gt;/arpwatch.table
    
    /arpwatch.php</p></div>
    ";i:3;s:6518:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    </pre></td><td class="code"><pre class="php" style="font-family:monospace;">#!/usr/local/bin/php
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #b1b100;">include_once</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;/engine.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$a</span><span style="color: #339933;">=</span><span style="color: #000000; font-weight: bold;">new</span> db_mysql<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$a</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">init</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;10.1.1.1&quot;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;arpwatch&quot;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;arpwatch&quot;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;freenibs&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$f</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;/arpwatch.table&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$f_array</span><span style="color: #339933;">=</span><span style="color: #990000;">file</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$f</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$n</span><span style="color: #339933;">=</span><span style="color: #990000;">count</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$f_array</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$i</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span> <span style="color: #000088;">$i</span><span style="color: #339933;">&lt;</span><span style="color: #000088;">$n</span><span style="color: #339933;">;</span><span style="color: #000088;">$i</span><span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
                <span style="color: #000088;">$str</span><span style="color: #339933;">=</span><span style="color: #990000;">explode</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot; &quot;</span><span style="color: #339933;">,</span><span style="color: #000088;">$f_array</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$i</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;INSERT INTO `arpwatch` (`ip`,`arp`) VALUES ('&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$str</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;','&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$str</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;') ON DUPLICATE KEY UPDATE `ip`='&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$str</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;',`date`=NOW()&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">//          echo $q.&quot;\n&quot;;</span>
                <span style="color: #000088;">$a</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #000088;">$a</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">close_db</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">#!/usr/local/bin/php
    &lt;?php
    include_once(&quot;/engine.php&quot;);
    $a=new db_mysql();
    $a-&gt;init(&quot;10.1.1.1&quot;,&quot;arpwatch&quot;,&quot;arpwatch&quot;,&quot;freenibs&quot;);
    $f=&quot;/arpwatch.table&quot;;
    
    $f_array=file($f);
    $n=count($f_array);
    for ($i=1; $i&lt;$n;$i++)
    {
                $str=explode(&quot; &quot;,$f_array[$i]);
    $q=&quot;INSERT INTO `arpwatch` (`ip`,`arp`) VALUES ('&quot;.quote_smart(trim($str[0])).&quot;','&quot;.quote_smart(trim($str[1])) .&quot;') ON DUPLICATE KEY UPDATE `ip`='&quot;.quote_smart(trim($str[0])).&quot;',`date`=NOW()&quot;;
    //          echo $q.&quot;\n&quot;;
                $a-&gt;query($q);
    }
    
    $a-&gt;close_db();
    ?&gt;</p></div>
    ";i:4;s:24541:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    36
    37
    38
    39
    40
    41
    42
    43
    44
    45
    46
    47
    48
    49
    50
    51
    52
    53
    54
    55
    56
    57
    58
    59
    60
    61
    62
    63
    64
    65
    66
    67
    68
    69
    70
    71
    72
    73
    74
    75
    76
    77
    78
    79
    80
    81
    82
    83
    84
    85
    86
    87
    88
    89
    90
    91
    92
    93
    94
    95
    96
    97
    98
    </pre></td><td class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #000000; font-weight: bold;">function</span> quote_smart<span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
    &nbsp;
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #990000;">get_magic_quotes_gpc</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$value</span> <span style="color: #339933;">=</span> <span style="color: #990000;">stripslashes</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
    &nbsp;
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #990000;">is_numeric</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$value</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_real_escape_string</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$value</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    &nbsp;
    &nbsp;
    <span style="color: #000000; font-weight: bold;">class</span> db_mysql<span style="color: #009900;">&#123;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$query</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$host</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$user</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$passw</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$db</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$link</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$res</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$temp_q</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$num</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000088;">$ar</span><span style="color: #339933;">;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span>  __construct <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #339933;">=</span><span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ar</span><span style="color: #339933;">=</span><span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">function</span> __destruct<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #339933;">@</span><span style="color: #990000;">mysql_close</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span>  init<span style="color: #009900;">&#40;</span><span style="color: #000088;">$HOST</span><span style="color: #339933;">,</span><span style="color: #000088;">$USER</span><span style="color: #339933;">,</span><span style="color: #000088;">$PASSW</span><span style="color: #339933;">,</span><span style="color: #000088;">$DB</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">set_host</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$HOST</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">set_user</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$USER</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">set_passw</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$PASSW</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">set_db</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$DB</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #339933;">=</span><span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ar</span><span style="color: #339933;">=</span><span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #339933;">=@</span><span style="color: #990000;">mysql_connect</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">host</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">user</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">passw</span><span style="color: #009900;">&#41;</span>or <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span>ERR1<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">db</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span> or <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span>ERR2<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #666666; font-style: italic;">//$q=&quot;SET NAMES utf8&quot;;</span>
                    <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">function</span> connect<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #339933;">=</span><span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">ar</span><span style="color: #339933;">=</span><span style="color: #990000;">array</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #339933;">=@</span><span style="color: #990000;">mysql_connect</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">host</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">user</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">passw</span><span style="color: #009900;">&#41;</span>or <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span>ERR1<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">db</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span> or <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span>ERR2<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> set_host<span style="color: #009900;">&#40;</span><span style="color: #000088;">$host</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">host</span><span style="color: #339933;">=</span><span style="color: #000088;">$host</span><span style="color: #339933;">;</span><span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> set_user<span style="color: #009900;">&#40;</span><span style="color: #000088;">$user</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">user</span><span style="color: #339933;">=</span><span style="color: #000088;">$user</span><span style="color: #339933;">;</span><span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> set_passw<span style="color: #009900;">&#40;</span><span style="color: #000088;">$passw</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">passw</span><span style="color: #339933;">=</span><span style="color: #000088;">$passw</span><span style="color: #339933;">;</span><span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> set_db<span style="color: #009900;">&#40;</span><span style="color: #000088;">$db</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">db</span><span style="color: #339933;">=</span><span style="color: #000088;">$db</span><span style="color: #339933;">;</span><span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span>  query<span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #339933;">=</span><span style="color: #990000;">mysql_db_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">db</span><span style="color: #339933;">,</span><span style="color: #000088;">$q</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;">//or die(ERR3);</span>
            <span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> num_rows<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">num</span><span style="color: #339933;">=</span><span style="color: #990000;">mysql_num_rows</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">num</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span>  fetch_row<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">res</span><span style="color: #339933;">=</span><span style="color: #990000;">mysql_fetch_row</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">res</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span>  fetch_array<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">res</span><span style="color: #339933;">=</span><span style="color: #990000;">mysql_fetch_array</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">query</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//or die(mysql_error());</span>
                    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">res</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> db_select<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">db</span><span style="color: #339933;">,</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span> or <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span>ERR2<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> free_result<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #990000;">mysql_free_result</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">res</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> close_db<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #009900;">&#123;</span>
                    <span style="color: #990000;">mysql_close</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #990000;">link</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    &nbsp;
    <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">&lt;?php
    function quote_smart($value)
    {
    
        if (get_magic_quotes_gpc()) {
            $value = stripslashes($value);
        }
    
        if (!is_numeric($value)) {
            $value = mysql_real_escape_string($value);
        }
        return $value;
    }
    
    
    
    class db_mysql{
        public $query;
        public $host;
        public $user;
        public $passw;
        public $db;
        public $link;
        public $res;
        public $temp_q;
        public $num;
        public $ar;
            public function  __construct ()
            {
                    $this-&gt;query=NULL;
                    $this-&gt;ar=array();
            }
    
            function __destruct()
            {
                    @mysql_close($this-&gt;link);
            }
    
            public function  init($HOST,$USER,$PASSW,$DB)
            {
                    self::set_host($HOST);
                    self::set_user($USER);
                    self::set_passw($PASSW);
                    self::set_db($DB);
                    $this-&gt;query=NULL;
                    $this-&gt;ar=array();
                    $this-&gt;link=@mysql_connect($this-&gt;host,$this-&gt;user, $this-&gt;passw)or die(ERR1);
                    mysql_select_db($this-&gt;db,$this-&gt;link) or die(ERR2);
                    //$q=&quot;SET NAMES utf8&quot;;
                    self::query($q);
            }
    
            function connect(){
                    $this-&gt;query=NULL;
                    $this-&gt;ar=array();
                    $this-&gt;link=@mysql_connect($this-&gt;host,$this-&gt;user, $this-&gt;passw)or die(ERR1);
                    mysql_select_db($this-&gt;db,$this-&gt;link) or die(ERR2);
            }
    
            public function set_host($host){$this-&gt;host=$host;}
            public function set_user($user){$this-&gt;user=$user;}
            public function set_passw($passw){$this-&gt;passw=$passw;}
            public function set_db($db){$this-&gt;db=$db;}
    
            public function  query($q){
                    $this-&gt;query=mysql_db_query($this-&gt;db,$q,$this-&gt;link);//or die(ERR3);
            }
            public function num_rows(){
                    $this-&gt;num=mysql_num_rows($this-&gt;query);
                    return $this-&gt;num;
            }
            public function  fetch_row(){
                    $this-&gt;res=mysql_fetch_row($this-&gt;query);
                    return $this-&gt;res;
            }
            public function  fetch_array(){
                    $this-&gt;res=mysql_fetch_array($this-&gt;query); //or die(mysql_error());
                    return $this-&gt;res;
            }
    
            public function db_select()
            {
                    mysql_select_db($this-&gt;db,$this-&gt;link) or die(ERR2);
            }
            public function free_result()
            {
                    mysql_free_result($this-&gt;res);
            }
    
            public function close_db()
            {
                    mysql_close($this-&gt;link);
            }
    
    }
    
    
    ?&gt;</p></div>
    ";i:5;s:7063:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    </pre></td><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">-- phpMyAdmin SQL Dump</span>
    <span style="color: #808080; font-style: italic;">-- version 3.1.2</span>
    <span style="color: #808080; font-style: italic;">-- http://www.phpmyadmin.net</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">SET</span> SQL_MODE<span style="color: #66cc66;">=</span><span style="color: #ff0000;">&quot;NO_AUTO_VALUE_ON_ZERO&quot;</span>;
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- База данных: `freenibs`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">-- --------------------------------------------------------</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- Структура таблицы `arpwatch`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`arpwatch`</span>;
    <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`arpwatch`</span> <span style="color: #66cc66;">&#40;</span>
      <span style="color: #ff0000;">`id`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`ip`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`arp`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`date`</span> <span style="color: #993333; font-weight: bold;">TIMESTAMP</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0000-00-00 00:00:00'</span> <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #993333; font-weight: bold;">CURRENT_TIMESTAMP</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span>  <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">UNIQUE</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #ff0000;">`ip`</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`ip`</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">`arp`</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #66cc66;">&#41;</span> ENGINE<span style="color: #66cc66;">=</span>MyISAM  <span style="color: #993333; font-weight: bold;">DEFAULT</span> CHARSET<span style="color: #66cc66;">=</span>latin1 <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4648</span> ;
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- Дамп данных таблицы `arpwatch`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> <span style="color: #ff0000;">`arpwatch`</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">`ip`</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">`arp`</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">`date`</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'10.1.5.1'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'00:02:b3:1e:01:e1'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'2009-12-24 02:27:14'</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table><p class="theCode" style="display:none;">-- phpMyAdmin SQL Dump
    -- version 3.1.2
    -- http://www.phpmyadmin.net
    --
    
    SET SQL_MODE=&quot;NO_AUTO_VALUE_ON_ZERO&quot;;
    
    --
    -- База данных: `freenibs`
    --
    
    -- --------------------------------------------------------
    
    --
    -- Структура таблицы `arpwatch`
    --
    
    DROP TABLE IF EXISTS `arpwatch`;
    CREATE TABLE IF NOT EXISTS `arpwatch` (
      `id` int(255) NOT NULL auto_increment,
      `ip` varchar(255) NOT NULL,
      `arp` varchar(255) NOT NULL,
      `date` timestamp NOT NULL default '0000-00-00 00:00:00' on update CURRENT_TIMESTAMP,
      PRIMARY KEY  (`id`),
      UNIQUE KEY `ip` (`ip`,`arp`)
    ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=4648 ;
    
    --
    -- Дамп данных таблицы `arpwatch`
    --
    
    INSERT INTO `arpwatch` (`id`, `ip`, `arp`, `date`) VALUES(4, '10.1.5.1', '00:02:b3:1e:01:e1', '2009-12-24 02:27:14');</p></div>
    ";}
categories:
  - billing
  - дополнения
tags:
  - arp
  - freeNIBS
  - mac
  - mysql

---
Данный скрипт и его копии на серверах доступа и роутерах стоят, что бы сливать инфу о мак-адресах в базу&#8230;
  
Эти данные потом используется другими скриптами. Отсюда видно кто куда и зачем )))
  
<!--more-->


  
>cat /etc/crontab|grep arp

<pre lang="bash">*/10    *       *       *       *       root /arpwatch.sh  > /dev/null
</pre>

>cat /arpwatch.sh

<pre lang="bash" line="1">#!/usr/local/bin/bash
#для моих реальников - начинаются с 91.203., но это не правильно)))
#тут надо было использовать egrep
#в общем не пишите так скрипты))) 
#@www.isp.pl.ua
############

arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2"K"$4"L"}' | grep 10. | grep -v "incomplet" | grep -v "ff:ff"|grep -v "91.203.">/arpwatch.table

arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep 10. | grep -v "incomplet" | grep -v "ff:ff"|grep -v "91.203.">/arpwatch.table

arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep 10. | grep -v "incomplet" | grep -v "ff:ff"|grep -v "91.203.">/arpwatch.table
arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep "172.168" | grep -v "incomplet" | grep -v "ff:ff">>/arpwatch.table
arp -a -n | tr '(' ' ' | tr ')' ' ' | awk '{print$2,$4}' | grep "91." | grep -v "incomplet" | grep -v "ff:ff">>/arpwatch.table

/arpwatch.php
</pre>

<pre lang="php" line="1">#!/usr/local/bin/php
<?php
include_once("/engine.php");
$a=new db_mysql();
$a->init("10.1.1.1","arpwatch","arpwatch","freenibs");
$f="/arpwatch.table";

$f_array=file($f);
$n=count($f_array);
for ($i=1; $i&lt;$n;$i++)
{
            $str=explode(" ",$f_array[$i]);
$q="INSERT INTO `arpwatch` (`ip`,`arp`) VALUES ('".quote_smart(trim($str[0]))."','".quote_smart(trim($str[1])) ."') ON DUPLICATE KEY UPDATE `ip`='".quote_smart(trim($str[0]))."',`date`=NOW()";
//          echo $q."\n";
            $a->query($q);
}

$a->close_db();
?>
</pre>

<pre lang="php" line="1"><?php
function quote_smart($value)
{

    if (get_magic_quotes_gpc()) {
        $value = stripslashes($value);
    }

    if (!is_numeric($value)) {
        $value = mysql_real_escape_string($value);
    }
    return $value;
}



class db_mysql{
    public $query;
    public $host;
    public $user;
    public $passw;
    public $db;
    public $link;
    public $res;
    public $temp_q;
    public $num;
    public $ar;
        public function  __construct ()
        {
                $this->query=NULL;
                $this->ar=array();
        }

        function __destruct()
        {
                @mysql_close($this->link);
        }

        public function  init($HOST,$USER,$PASSW,$DB)
        {
                self::set_host($HOST);
                self::set_user($USER);
                self::set_passw($PASSW);
                self::set_db($DB);
                $this->query=NULL;
                $this->ar=array();
                $this->link=@mysql_connect($this->host,$this->user, $this->passw)or die(ERR1);
                mysql_select_db($this->db,$this->link) or die(ERR2);
                //$q="SET NAMES utf8";
                self::query($q);
        }

        function connect(){
                $this->query=NULL;
                $this->ar=array();
                $this->link=@mysql_connect($this->host,$this->user, $this->passw)or die(ERR1);
                mysql_select_db($this->db,$this->link) or die(ERR2);
        }

        public function set_host($host){$this->host=$host;}
        public function set_user($user){$this->user=$user;}
        public function set_passw($passw){$this->passw=$passw;}
        public function set_db($db){$this->db=$db;}

        public function  query($q){
                $this->query=mysql_db_query($this->db,$q,$this->link);//or die(ERR3);
        }
        public function num_rows(){
                $this->num=mysql_num_rows($this->query);
                return $this->num;
        }
        public function  fetch_row(){
                $this->res=mysql_fetch_row($this->query);
                return $this->res;
        }
        public function  fetch_array(){
                $this->res=mysql_fetch_array($this->query); //or die(mysql_error());
                return $this->res;
        }

        public function db_select()
        {
                mysql_select_db($this->db,$this->link) or die(ERR2);
        }
        public function free_result()
        {
                mysql_free_result($this->res);
        }

        public function close_db()
        {
                mysql_close($this->link);
        }

}


?>

</pre>

dump:

<pre lang="sql" line="1">-- phpMyAdmin SQL Dump
-- version 3.1.2
-- http://www.phpmyadmin.net
--

SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";

--
-- База данных: `freenibs`
--

-- --------------------------------------------------------

--
-- Структура таблицы `arpwatch`
--

DROP TABLE IF EXISTS `arpwatch`;
CREATE TABLE IF NOT EXISTS `arpwatch` (
  `id` int(255) NOT NULL auto_increment,
  `ip` varchar(255) NOT NULL,
  `arp` varchar(255) NOT NULL,
  `date` timestamp NOT NULL default '0000-00-00 00:00:00' on update CURRENT_TIMESTAMP,
  PRIMARY KEY  (`id`),
  UNIQUE KEY `ip` (`ip`,`arp`)
) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=4648 ;

--
-- Дамп данных таблицы `arpwatch`
--

INSERT INTO `arpwatch` (`id`, `ip`, `arp`, `date`) VALUES(4, '10.1.5.1', '00:02:b3:1e:01:e1', '2009-12-24 02:27:14');
</pre>