---
title: Работа с зависшими пользователями
author: wel
type: post
date: 2009-07-23T11:09:52+00:00
url: /billing/работа-с-зависшими-пользователями
short-url:
  - http://bit.ly/g1Ur0Y
wp-syntax-cache-content:
  - |
    a:8:{i:1;s:6628:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    </pre></td><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/bin/sh</span>
    &nbsp;
    <span style="color: #007800;">USER</span>=<span style="color: #ff0000;">'freenibs'</span>
    <span style="color: #007800;">PASSWORD</span>=<span style="color: #ff0000;">'freenibs'</span>
    <span style="color: #007800;">DATABASE</span>=<span style="color: #ff0000;">'freenibs'</span>
    <span style="color: #666666; font-style: italic;">#USER='root'</span>
    &nbsp;
    <span style="color: #007800;">TIMEOUT</span>=<span style="color: #000000;">180</span>
    &nbsp;
    <span style="color: #007800;">res</span>=<span style="color: #000000; font-weight: bold;">`/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysql <span style="color: #660033;">-B</span> <span style="color: #660033;">-s</span> <span style="color: #660033;">-u</span> <span style="color: #007800;">$USER</span> -p<span style="color: #007800;">$PASSWORD</span> <span style="color: #007800;">$DATABASE</span> <span style="color: #660033;">-e</span> \
    <span style="color: #ff0000;">&quot;select unique_id from actions <span style="color: #000099; font-weight: bold;">\
    </span>where terminate_cause = 'Online' and (UNIX_TIMESTAMP() - last_change) &gt; <span style="color: #007800;">$TIMEOUT</span>&quot;</span><span style="color: #000000; font-weight: bold;">`</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">#Можно использовать and server='127.0.0.1' или любой другой ИП для СЕРВЕРА доступа)))</span>
    &nbsp;
    <span style="color: #007800;">nasport</span>=<span style="color: #000000; font-weight: bold;">`/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysql <span style="color: #660033;">-B</span> <span style="color: #660033;">-s</span> <span style="color: #660033;">-u</span> <span style="color: #007800;">$USER</span> -p<span style="color: #007800;">$PASSWORD</span> <span style="color: #007800;">$DATABASE</span> <span style="color: #660033;">-e</span> \
    <span style="color: #ff0000;">&quot;select port from actions <span style="color: #000099; font-weight: bold;">\
    </span>where terminate_cause = 'Online'   and (UNIX_TIMESTAMP() - last_change) &gt; <span style="color: #007800;">$TIMEOUT</span>&quot;</span><span style="color: #000000; font-weight: bold;">`</span>
    &nbsp;
    &nbsp;
    &nbsp;
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #660033;">-n</span> <span style="color: #ff0000;">&quot;<span style="color: #007800;">$res</span>&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;session ids:&quot;</span> <span style="color: #007800;">$res</span>
    <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;nasport:&quot;</span> <span style="color: #007800;">$nasport</span>
    &nbsp;
    <span style="color: #007800;">res</span>=<span style="color: #000000; font-weight: bold;">`/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysql <span style="color: #660033;">-B</span> <span style="color: #660033;">-s</span> <span style="color: #660033;">-u</span> <span style="color: #007800;">$USER</span> -p<span style="color: #007800;">$PASSWORD</span> <span style="color: #007800;">$DATABASE</span> <span style="color: #660033;">-e</span> \
    <span style="color: #ff0000;">&quot;update actions set terminate_cause = 'User-Request', <span style="color: #000099; font-weight: bold;">\
    </span>stop_time = date_add(start_time, interval ifnull(time_on, 0) second) <span style="color: #000099; font-weight: bold;">\
    </span>where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) &gt; <span style="color: #007800;">$TIMEOUT</span>&quot;</span><span style="color: #000000; font-weight: bold;">`</span>
    <span style="color: #000000; font-weight: bold;">fi</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">for</span> p <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #007800;">$nasport</span>; <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>raddb<span style="color: #000000; font-weight: bold;">/</span>userkill.pl <span style="color: #000000;">1</span> <span style="color: #000000;">2</span> <span style="color: #000000;">3</span> <span style="color: #007800;">$p</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">done</span></pre></td></tr></table><p class="theCode" style="display:none;">#!/bin/sh
    
    USER='freenibs'
    PASSWORD='freenibs'
    DATABASE='freenibs'
    #USER='root'
    
    TIMEOUT=180
    
    res=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
    &quot;select unique_id from actions \
    where terminate_cause = 'Online' and (UNIX_TIMESTAMP() - last_change) &gt; $TIMEOUT&quot;`
    
    #Можно использовать and server='127.0.0.1' или любой другой ИП для СЕРВЕРА доступа)))
    
    nasport=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
    &quot;select port from actions \
    where terminate_cause = 'Online'   and (UNIX_TIMESTAMP() - last_change) &gt; $TIMEOUT&quot;`
    
    
    
    if [ -n &quot;$res&quot; ]; then
    echo &quot;session ids:&quot; $res
    echo &quot;nasport:&quot; $nasport
    
    res=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
    &quot;update actions set terminate_cause = 'User-Request', \
    stop_time = date_add(start_time, interval ifnull(time_on, 0) second) \
    where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) &gt; $TIMEOUT&quot;`
    fi
    
    for p in $nasport; do
    /usr/local/etc/raddb/userkill.pl 1 2 3 $p
    
    done</p></div>
    ";i:2;s:8337:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    </pre></td><td class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/usr/local/bin/perl</span>
    <span style="color: #666666; font-style: italic;">#</span>
    <span style="color: #666666; font-style: italic;">#Это старая версия скрипта</span>
    <span style="color: #666666; font-style: italic;">#Тут надо вручную указывать сервер доступа</span>
    <span style="color: #0000ff;">$hostname</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;127.0.0.1&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$port</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;5005&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span> <span style="color: #b1b100;">eq</span> <span style="color: #ff0000;">''</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">die</span> <span style="color: #ff0000;">'Usage:  user nasip userip nasport'</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$user</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$nasip</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$userip</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$nasport</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">#$nasport=$nasport+1;</span>
    &nbsp;
    <span style="color: #0000ff;">$hostname</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;127.0.0.1&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$port</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;5005&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">use</span> Net<span style="color: #339933;">::</span><span style="color: #006600;">Telnet</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$t</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Net<span style="color: #339933;">::</span><span style="color: #006600;">Telnet</span> <span style="color: #009900;">&#40;</span>Timeout <span style="color: #339933;">=&gt;</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>Port <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">$port</span><span style="color: #339933;">,</span>Binmode <span style="color: #339933;">=&gt;</span> <span style="color: #ff0000;">'\015\012'</span><span style="color: #339933;">,</span>
                                   Prompt <span style="color: #339933;">=&gt;</span> <span style="color: #ff0000;">'/\[\]/'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;$hostname&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">login</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;mpd&quot;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;mpd_password&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;link L-&quot;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">$nasport</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;close&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;exit&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">close</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000066;">exit</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span></pre></td></tr></table><p class="theCode" style="display:none;">#!/usr/local/bin/perl
    #
    #Это старая версия скрипта
    #Тут надо вручную указывать сервер доступа
    $hostname=&quot;127.0.0.1&quot;;
    $port=&quot;5005&quot;;
    if( $ARGV[3] eq '' ) { die 'Usage:  user nasip userip nasport'; };
    
    $user=$ARGV[0];
    $nasip=$ARGV[1];
    $userip=$ARGV[2];
    $nasport=$ARGV[3];
    
    #$nasport=$nasport+1;
    
    $hostname=&quot;127.0.0.1&quot;;
    
    $port=&quot;5005&quot;;
    
    use Net::Telnet ();
    
    $t = new Net::Telnet (Timeout =&gt; 2,Port =&gt; $port,Binmode =&gt; '\015\012',
                                   Prompt =&gt; '/\[\]/');
    $t-&gt;open(&quot;$hostname&quot;);
    $t-&gt;login(&quot;mpd&quot;, &quot;mpd_password&quot;);
    
    $t-&gt;print(&quot;link L-&quot;.$nasport);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;print(&quot;close&quot;);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;print(&quot;exit&quot;);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;close();
    exit 0;</p></div>
    ";i:3;s:4404:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#pkg_info |grep perl</span>
    libtext-charwidth-perl-<span style="color: #000000;">0.04</span> Documentation <span style="color: #c20cb9; font-weight: bold;">gettext</span> tools
    libtext-wrapi18n-perl-<span style="color: #000000;">0.06</span> Documentation <span style="color: #c20cb9; font-weight: bold;">gettext</span> tools
    p5-DBI-1.60.7       The perl5 Database Interface.  Required <span style="color: #000000; font-weight: bold;">for</span> DBD::<span style="color: #000000; font-weight: bold;">*</span> modules
    p5-Net-Radius-<span style="color: #000000;">1.56</span>  A <span style="color: #c20cb9; font-weight: bold;">perl</span> module to manipulate RADIUS packets
    p5-SNMP_Session-<span style="color: #000000;">1.12</span> A perl5 module providing rudimentary access to SNMPv1 and v
    p5-Scalar-List-Utils-<span style="color: #000000;">1.19</span>,<span style="color: #000000;">1</span> Perl subroutines that would be <span style="color: #c20cb9; font-weight: bold;">nice</span> to have <span style="color: #000000; font-weight: bold;">in</span> the <span style="color: #c20cb9; font-weight: bold;">perl</span> cor
    p5-Storable-<span style="color: #000000;">2.18</span>    Persistency <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #c20cb9; font-weight: bold;">perl</span> data structures
    p5-Term-ReadKey-<span style="color: #000000;">2.30</span> A perl5 module <span style="color: #000000; font-weight: bold;">for</span> simple terminal control
    p5-Test-Harness-<span style="color: #000000;">3.14</span>_2 Run <span style="color: #c20cb9; font-weight: bold;">perl</span> standard <span style="color: #7a0874; font-weight: bold;">test</span> scripts with statistics
    p5-Test-Simple-<span style="color: #000000;">0.86</span> Basic utilities <span style="color: #000000; font-weight: bold;">for</span> writing tests <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #c20cb9; font-weight: bold;">perl</span>
    p5-Time-HiRes-<span style="color: #000000;">1.9719</span>,<span style="color: #000000;">1</span> A perl5 module implementing High resolution <span style="color: #000000; font-weight: bold;">time</span>, <span style="color: #c20cb9; font-weight: bold;">sleep</span>, an
    perl-5.8.9_1        Practical Extraction and Report Language
    &nbsp;
    <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000;">13</span>:<span style="color: #000000;">20</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> wel<span style="color: #000000; font-weight: bold;">@</span>server  <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>wel <span style="color: #666666; font-style: italic;">#uname -a</span>
    FreeBSD server.home <span style="color: #000000;">6.2</span>-RELEASE-p12 FreeBSD <span style="color: #000000;">6.2</span>-RELEASE-p12 <span style="color: #666666; font-style: italic;">#11: Mon Jan  5 02:37:52 EET 2009     wel@server.home:/usr/obj/usr/src/sys/SERVER  i386</span></pre></td></tr></table><p class="theCode" style="display:none;">#pkg_info |grep perl
    libtext-charwidth-perl-0.04 Documentation gettext tools
    libtext-wrapi18n-perl-0.06 Documentation gettext tools
    p5-DBI-1.60.7       The perl5 Database Interface.  Required for DBD::* modules
    p5-Net-Radius-1.56  A perl module to manipulate RADIUS packets
    p5-SNMP_Session-1.12 A perl5 module providing rudimentary access to SNMPv1 and v
    p5-Scalar-List-Utils-1.19,1 Perl subroutines that would be nice to have in the perl cor
    p5-Storable-2.18    Persistency for perl data structures
    p5-Term-ReadKey-2.30 A perl5 module for simple terminal control
    p5-Test-Harness-3.14_2 Run perl standard test scripts with statistics
    p5-Test-Simple-0.86 Basic utilities for writing tests in perl
    p5-Time-HiRes-1.9719,1 A perl5 module implementing High resolution time, sleep, an
    perl-5.8.9_1        Practical Extraction and Report Language
    
    [13:20] wel@server  /usr/home/wel #uname -a
    FreeBSD server.home 6.2-RELEASE-p12 FreeBSD 6.2-RELEASE-p12 #11: Mon Jan  5 02:37:52 EET 2009     wel@server.home:/usr/obj/usr/src/sys/SERVER  i386</p></div>
    ";i:4;s:331:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">startup:
        <span style="color: #000000; font-weight: bold;">set</span> user foo bar admin</pre></td></tr></table><p class="theCode" style="display:none;">startup:
        set user foo bar admin</p></div>
    ";i:5;s:5285:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    </pre></td><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>wel <span style="color: #000000; font-weight: bold;">&gt;</span>telnet 127.0.0.1 <span style="color: #000000;">5005</span>
    Connected to 127.0.0.1.
    Escape character is <span style="color: #ff0000;">'^]'</span>.
    Multi-link PPP daemon <span style="color: #000000; font-weight: bold;">for</span> FreeBSD
    &nbsp;
    Username: mpd
    Password:
    &nbsp;
    Welcome<span style="color: #000000; font-weight: bold;">!</span>
    Mpd pid <span style="color: #000000;">5377</span>, version <span style="color: #000000;">5.5</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>root<span style="color: #000000; font-weight: bold;">@</span>nas1 03:<span style="color: #000000;">47</span>  <span style="color: #000000;">1</span>-Dec-<span style="color: #000000;">2010</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
    <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> show summary
    Current daemon status summary
    Iface   Bund            Link    LCP     Device          User            From
                            L       Initial pptp    DOWN                    UNSPEC
                            L1      Initial pptp    DOWN                    UNSPEC
                            L2      Initial pptp    DOWN                    UNSPEC
            B       Down
            B1      Down
            B2      Down
    ng44    B-<span style="color: #000000;">47</span>    Up      L-<span style="color: #000000;">47</span>    Opened  pptp    UP          slim        10.1.20.18
    <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>
    <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span>
    Available commands:
     authname : Choose <span style="color: #c20cb9; font-weight: bold;">link</span> by auth name     bundle   : Choose<span style="color: #000000; font-weight: bold;">/</span>list bundles
     close    : Close a layer                create   : Create new item
     destroy  : Destroy item                 <span style="color: #7a0874; font-weight: bold;">exit</span>     : Exit console
     iface    : Choose bundle by iface       <span style="color: #7a0874; font-weight: bold;">help</span>     : Help on any <span style="color: #7a0874; font-weight: bold;">command</span>
     <span style="color: #c20cb9; font-weight: bold;">link</span>     : Choose <span style="color: #c20cb9; font-weight: bold;">link</span>                  load     : Read from config <span style="color: #c20cb9; font-weight: bold;">file</span>
     log      : Set<span style="color: #000000; font-weight: bold;">/</span>view log options         msession : Ch. bundle by msession-id
     open     : Open a layer                 quit     : Quit program
     repeater : Choose<span style="color: #000000; font-weight: bold;">/</span>list repeaters        session  : Choose <span style="color: #c20cb9; font-weight: bold;">link</span> by session-id
     <span style="color: #000000; font-weight: bold;">set</span>      : Set parameters               show     : Show status
    <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> authname slim
    <span style="color: #7a0874; font-weight: bold;">&#91;</span>L-<span style="color: #000000;">47</span><span style="color: #7a0874; font-weight: bold;">&#93;</span></pre></td></tr></table><p class="theCode" style="display:none;">/home/wel &gt;telnet 127.0.0.1 5005
    Connected to 127.0.0.1.
    Escape character is '^]'.
    Multi-link PPP daemon for FreeBSD
    
    Username: mpd
    Password:
    
    Welcome!
    Mpd pid 5377, version 5.5 (root@nas1 03:47  1-Dec-2010)
    [] show summary
    Current daemon status summary
    Iface   Bund            Link    LCP     Device          User            From
                            L       Initial pptp    DOWN                    UNSPEC
                            L1      Initial pptp    DOWN                    UNSPEC
                            L2      Initial pptp    DOWN                    UNSPEC
            B       Down
            B1      Down
            B2      Down
    ng44    B-47    Up      L-47    Opened  pptp    UP          slim        10.1.20.18
    []
    []
    Available commands:
     authname : Choose link by auth name     bundle   : Choose/list bundles
     close    : Close a layer                create   : Create new item
     destroy  : Destroy item                 exit     : Exit console
     iface    : Choose bundle by iface       help     : Help on any command
     link     : Choose link                  load     : Read from config file
     log      : Set/view log options         msession : Ch. bundle by msession-id
     open     : Open a layer                 quit     : Quit program
     repeater : Choose/list repeaters        session  : Choose link by session-id
     set      : Set parameters               show     : Show status
    [] authname slim
    [L-47]</p></div>
    ";i:6;s:9200:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    36
    37
    </pre></td><td class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/usr/local/bin/perl</span>
    <span style="color: #666666; font-style: italic;">#</span>
    <span style="color: #666666; font-style: italic;">#Это новая версия скрипта</span>
    <span style="color: #666666; font-style: italic;">#Тут не надо вручную указывать сервер доступа</span>
    <span style="color: #0000ff;">$hostname</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;127.0.0.1&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$port</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;5005&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span> <span style="color: #b1b100;">eq</span> <span style="color: #ff0000;">''</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">die</span> <span style="color: #ff0000;">'Usage:  user nasip userip nasport'</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$user</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$nasip</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$userip</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$nasport</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$ARGV</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">#$nasport=$nasport+1;</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">#$hostname=&quot;127.0.0.1&quot;;</span>
    <span style="color: #0000ff;">$hostname</span><span style="color: #339933;">=</span><span style="color: #0000ff;">$nasip</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$port</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;5005&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">use</span> Net<span style="color: #339933;">::</span><span style="color: #006600;">Telnet</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$t</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Net<span style="color: #339933;">::</span><span style="color: #006600;">Telnet</span> <span style="color: #009900;">&#40;</span>Timeout <span style="color: #339933;">=&gt;</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>Port <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">$port</span><span style="color: #339933;">,</span>Binmode <span style="color: #339933;">=&gt;</span> <span style="color: #ff0000;">'\015\012'</span><span style="color: #339933;">,</span>
                                   Prompt <span style="color: #339933;">=&gt;</span> <span style="color: #ff0000;">'/\[\]/'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;$hostname&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">login</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;mpd&quot;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;mpd_password&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;link L-&quot;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">$nasport</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;authname &quot;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">$user</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;close&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;exit&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #0000ff;">$t</span><span style="color: #339933;">-&gt;</span><span style="color: #000066;">close</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000066;">exit</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span></pre></td></tr></table><p class="theCode" style="display:none;">#!/usr/local/bin/perl
    #
    #Это новая версия скрипта
    #Тут не надо вручную указывать сервер доступа
    $hostname=&quot;127.0.0.1&quot;;
    $port=&quot;5005&quot;;
    if( $ARGV[3] eq '' ) { die 'Usage:  user nasip userip nasport'; };
    
    $user=$ARGV[0];
    $nasip=$ARGV[1];
    $userip=$ARGV[2];
    $nasport=$ARGV[3];
    
    #$nasport=$nasport+1;
    
    #$hostname=&quot;127.0.0.1&quot;;
    $hostname=$nasip;
    
    $port=&quot;5005&quot;;
    
    use Net::Telnet ();
    
    $t = new Net::Telnet (Timeout =&gt; 2,Port =&gt; $port,Binmode =&gt; '\015\012',
                                   Prompt =&gt; '/\[\]/');
    $t-&gt;open(&quot;$hostname&quot;);
    $t-&gt;login(&quot;mpd&quot;, &quot;mpd_password&quot;);
    
    $t-&gt;print(&quot;link L-&quot;.$nasport);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;print(&quot;authname &quot;.$user);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;print(&quot;close&quot;);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;print(&quot;exit&quot;);
    $t-&gt;print(&quot;&quot;);
    $t-&gt;close();
    exit 0;</p></div>
    ";i:7;s:9954:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    36
    37
    38
    39
    40
    41
    42
    43
    44
    45
    46
    47
    48
    49
    </pre></td><td class="code"><pre class="php" style="font-family:monospace;">#!/usr/local/bin/php
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #000088;">$link</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_connect</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'10.1.1.1'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$link</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Could not connect: '</span> <span style="color: #339933;">.</span> <span style="color: #990000;">mysql_error</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #666666; font-style: italic;">/*  */</span>
    &nbsp;
    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;freenibs&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$TIMEOUT</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">180</span><span style="color: #339933;">;</span>
    &nbsp;
    &nbsp;
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;select 
           `unique_id`,
           `port`,
           `user`,
           `client_ip`,
           `server`
    from 
           `actions`
    where 
             `terminate_cause` = 'Online' and (UNIX_TIMESTAMP() - last_change) &gt; <span style="color: #006699; font-weight: bold;">$TIMEOUT</span>&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$result</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$num_rows</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_num_rows</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$result</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$num_rows</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
             <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_fetch_array</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$result</span><span style="color: #339933;">,</span> MYSQL_ASSOC<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$unique_id</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'unique_id'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$port</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'port'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$user</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'user'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$server</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'server'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
                     <span style="color: #000088;">$userip</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'client_ip'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
                     <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;session: &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$unique_id</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; will rise :)<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$last_line</span> <span style="color: #339933;">=</span> <span style="color: #990000;">system</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'/usr/local/etc/raddb/userkill_nas_new.pl '</span><span style="color: #339933;">.</span><span style="color: #000088;">$user</span><span style="color: #339933;">.</span><span style="color: #0000ff;">' '</span><span style="color: #339933;">.</span><span style="color: #000088;">$server</span><span style="color: #339933;">.</span><span style="color: #0000ff;">' '</span><span style="color: #339933;">.</span><span style="color: #000088;">$userip</span><span style="color: #339933;">.</span><span style="color: #0000ff;">' '</span><span style="color: #339933;">.</span><span style="color: #000088;">$port</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&quot;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$retval</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
             <span style="color: #009900;">&#125;</span>
    &nbsp;
    &nbsp;
    <span style="color: #666666; font-style: italic;">//чистим сессии</span>
    <span style="color: #666666; font-style: italic;">//только смотрите - могут новые появиться, пока выполнялся скрипт</span>
    <span style="color: #666666; font-style: italic;">//можно так)))</span>
    <span style="color: #000088;">$TIMEOUT</span><span style="color: #339933;">=+</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;update actions set terminate_cause = 'User-Request', <span style="color: #000099; font-weight: bold;">\
    </span>stop_time = date_add(start_time, interval ifnull(time_on, 0) second) <span style="color: #000099; font-weight: bold;">\
    </span>where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) &gt; <span style="color: #006699; font-weight: bold;">$TIMEOUT</span>&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$result</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span></pre></td></tr></table><p class="theCode" style="display:none;">#!/usr/local/bin/php
    &lt;?php
    $link = mysql_connect('10.1.1.1', 'freenibs', 'freenibs');
    if (!$link) {
            die('Could not connect: ' . mysql_error());
    }
    /*  */
    
    mysql_select_db(&quot;freenibs&quot;);
    
    $TIMEOUT=180;
    
    
    $q=&quot;select 
           `unique_id`,
           `port`,
           `user`,
           `client_ip`,
           `server`
    from 
           `actions`
    where 
             `terminate_cause` = 'Online' and (UNIX_TIMESTAMP() - last_change) &gt; $TIMEOUT&quot;;
    
    $result = mysql_query($q);
    $num_rows = mysql_num_rows($result);
    if($num_rows&gt;0){
             while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) {
                    $unique_id=$row['unique_id'];
                    $port=$row['port'];
                    $user=$row['user'];
                    $server=$row['server'];
                     $userip=$row['client_ip'];
                     echo &quot;session: &quot;.$unique_id.&quot; will rise :)\n&quot;;
                    $last_line = system('/usr/local/etc/raddb/userkill_nas_new.pl '.$user.' '.$server.' '.$userip.' '.$port.&quot;&quot;, $retval);
             }
    
    
    //чистим сессии
    //только смотрите - могут новые появиться, пока выполнялся скрипт
    //можно так)))
    $TIMEOUT=+2;
    
    $q=&quot;update actions set terminate_cause = 'User-Request', \
    stop_time = date_add(start_time, interval ifnull(time_on, 0) second) \
    where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) &gt; $TIMEOUT&quot;;
    $result = mysql_query($q);
    
    }</p></div>
    ";i:8;s:1131:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">*/</span><span style="color: #000000;">5</span>        <span style="color: #000000; font-weight: bold;">*</span>    <span style="color: #000000; font-weight: bold;">*</span>       <span style="color: #000000; font-weight: bold;">*</span>       <span style="color: #000000; font-weight: bold;">*</span>       root    <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>mpd5<span style="color: #000000; font-weight: bold;">/</span>freez_user_kill.php  <span style="color: #000000;">2</span><span style="color: #000000; font-weight: bold;">&gt;&amp;</span><span style="color: #000000;">1</span></pre></td></tr></table><p class="theCode" style="display:none;">*/5        *    *       *       *       root    /usr/local/etc/mpd5/freez_user_kill.php  2&gt;&amp;1</p></div>
    ";}
categories:
  - billing
  - дополнения
tags:
  - drop
  - freeNIBS
  - kill
  - mpd
  - mpd5
  - perl
  - php
  - user

---
Работа с зависшими пользователями, zapped users)))
  
В наличии FreeBSD сервер, mpd5/mpd4 сервер доступа.

Давно нарыл скрипт, который киляет зависших пользователей при таймауте сессии в 180сек. Я пытался меньше сделать &#8212; но ничего не получается, нормальные сессии падают(((

freez\_user\_kill.sh:
  
<!--more-->

<pre lang="bash" line="1">#!/bin/sh

USER='freenibs'
PASSWORD='freenibs'
DATABASE='freenibs'
#USER='root'

TIMEOUT=180

res=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
"select unique_id from actions \
where terminate_cause = 'Online' and (UNIX_TIMESTAMP() - last_change) > $TIMEOUT"`

#Можно использовать and server='127.0.0.1' или любой другой ИП для СЕРВЕРА доступа)))

nasport=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
"select port from actions \
where terminate_cause = 'Online'   and (UNIX_TIMESTAMP() - last_change) > $TIMEOUT"`



if [ -n "$res" ]; then
echo "session ids:" $res
echo "nasport:" $nasport

res=`/usr/local/bin/mysql -B -s -u $USER -p$PASSWORD $DATABASE -e \
"update actions set terminate_cause = 'User-Request', \
stop_time = date_add(start_time, interval ifnull(time_on, 0) second) \
where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) > $TIMEOUT"`
fi

for p in $nasport; do
/usr/local/etc/raddb/userkill.pl 1 2 3 $p

done


</pre>

Скрипт непосредственного &#171;сбрасывания&#187; пользователя -/usr/local/etc/raddb/userkill.pl.
  
Но с этим скриптом есть беда после использования mpd5.4 &#8212; у него такой параметр как nasport в базе billng&#8217;a FreeNIBS не совпадает с тем чем надо))):

<pre lang="perl" line="1">#!/usr/local/bin/perl
#
#Это старая версия скрипта
#Тут надо вручную указывать сервер доступа
$hostname="127.0.0.1";
$port="5005";
if( $ARGV[3] eq '' ) { die 'Usage:  user nasip userip nasport'; };

$user=$ARGV[0];
$nasip=$ARGV[1];
$userip=$ARGV[2];
$nasport=$ARGV[3];

#$nasport=$nasport+1;

$hostname="127.0.0.1";

$port="5005";

use Net::Telnet ();

$t = new Net::Telnet (Timeout => 2,Port => $port,Binmode => '\015\012',
                               Prompt => '/\[\]/');
$t->open("$hostname");
$t->login("mpd", "mpd_password");

$t->print("link L-".$nasport);
$t->print("");
$t->print("close");
$t->print("");
$t->print("exit");
$t->print("");
$t->close();
exit 0;
</pre>

<pre lang="bash">#pkg_info |grep perl
libtext-charwidth-perl-0.04 Documentation gettext tools
libtext-wrapi18n-perl-0.06 Documentation gettext tools
p5-DBI-1.60.7       The perl5 Database Interface.  Required for DBD::* modules
p5-Net-Radius-1.56  A perl module to manipulate RADIUS packets
p5-SNMP_Session-1.12 A perl5 module providing rudimentary access to SNMPv1 and v
p5-Scalar-List-Utils-1.19,1 Perl subroutines that would be nice to have in the perl cor
p5-Storable-2.18    Persistency for perl data structures
p5-Term-ReadKey-2.30 A perl5 module for simple terminal control
p5-Test-Harness-3.14_2 Run perl standard test scripts with statistics
p5-Test-Simple-0.86 Basic utilities for writing tests in perl
p5-Time-HiRes-1.9719,1 A perl5 module implementing High resolution time, sleep, an
perl-5.8.9_1        Practical Extraction and Report Language

[13:20] wel@server  /usr/home/wel #uname -a
FreeBSD server.home 6.2-RELEASE-p12 FreeBSD 6.2-RELEASE-p12 #11: Mon Jan  5 02:37:52 EET 2009     wel@server.home:/usr/obj/usr/src/sys/SERVER  i386
</pre>

Нам надо &#171;подконфигурировать&#187; mpd5:
   
/usr/local/etc/mpd5/mpd.conf а именно надо следить, что бы в конце были заветные admin!!!:

<pre lang="bash">startup:
    set user foo bar admin
</pre>

Дальше пример сессии:

<pre lang="bash" line="1">/home/wel >telnet 127.0.0.1 5005
Connected to 127.0.0.1.
Escape character is '^]'.
Multi-link PPP daemon for FreeBSD

Username: mpd
Password:

Welcome!
Mpd pid 5377, version 5.5 (root@nas1 03:47  1-Dec-2010)
[] show summary
Current daemon status summary
Iface   Bund            Link    LCP     Device          User            From
                        L       Initial pptp    DOWN                    UNSPEC
                        L1      Initial pptp    DOWN                    UNSPEC
                        L2      Initial pptp    DOWN                    UNSPEC
        B       Down
        B1      Down
        B2      Down
ng44    B-47    Up      L-47    Opened  pptp    UP          slim        10.1.20.18
[]
[]
Available commands:
 authname : Choose link by auth name     bundle   : Choose/list bundles
 close    : Close a layer                create   : Create new item
 destroy  : Destroy item                 exit     : Exit console
 iface    : Choose bundle by iface       help     : Help on any command
 link     : Choose link                  load     : Read from config file
 log      : Set/view log options         msession : Ch. bundle by msession-id
 open     : Open a layer                 quit     : Quit program
 repeater : Choose/list repeaters        session  : Choose link by session-id
 set      : Set parameters               show     : Show status
[] authname slim
[L-47]

</pre>

Как видно по имени пользователя Я перешёл на [L-47]

Новая версия /usr/local/etc/raddb/userkill\_nas\_new.pl:

<pre lang="perl" line="1">#!/usr/local/bin/perl
#
#Это новая версия скрипта
#Тут не надо вручную указывать сервер доступа
$hostname="127.0.0.1";
$port="5005";
if( $ARGV[3] eq '' ) { die 'Usage:  user nasip userip nasport'; };

$user=$ARGV[0];
$nasip=$ARGV[1];
$userip=$ARGV[2];
$nasport=$ARGV[3];

#$nasport=$nasport+1;

#$hostname="127.0.0.1";
$hostname=$nasip;

$port="5005";

use Net::Telnet ();

$t = new Net::Telnet (Timeout => 2,Port => $port,Binmode => '\015\012',
                               Prompt => '/\[\]/');
$t->open("$hostname");
$t->login("mpd", "mpd_password");

$t->print("link L-".$nasport);
$t->print("");
$t->print("authname ".$user);
$t->print("");
$t->print("close");
$t->print("");
$t->print("exit");
$t->print("");
$t->close();
exit 0;
</pre>

Новая версия скрипта для сбрасывания пользователей:
  
freez\_user\_kill.php

<pre lang="php" line="1">#!/usr/local/bin/php
<?php
$link = mysql_connect('10.1.1.1', 'freenibs', 'freenibs');
if (!$link) {
        die('Could not connect: ' . mysql_error());
}
/*  */

mysql_select_db("freenibs");

$TIMEOUT=180;


$q="select 
       `unique_id`,
       `port`,
       `user`,
       `client_ip`,
       `server`
from 
       `actions`
where 
         `terminate_cause` = 'Online' and (UNIX_TIMESTAMP() - last_change) > $TIMEOUT";

$result = mysql_query($q);
$num_rows = mysql_num_rows($result);
if($num_rows>0){
         while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) {
                $unique_id=$row['unique_id'];
                $port=$row['port'];
                $user=$row['user'];
                $server=$row['server'];
                 $userip=$row['client_ip'];
                 echo "session: ".$unique_id." will rise :)\n";
                $last_line = system('/usr/local/etc/raddb/userkill_nas_new.pl '.$user.' '.$server.' '.$userip.' '.$port."", $retval);
         }


//чистим сессии
//только смотрите - могут новые появиться, пока выполнялся скрипт
//можно так)))
$TIMEOUT=+2;

$q="update actions set terminate_cause = 'User-Request', \
stop_time = date_add(start_time, interval ifnull(time_on, 0) second) \
where terminate_cause = 'Online'  and (UNIX_TIMESTAMP() - last_change) > $TIMEOUT";
$result = mysql_query($q);

}

</pre>

В кронтаб (crontab)

<pre lang="bash">*/5        *    *       *       *       root    /usr/local/etc/mpd5/freez_user_kill.php  2>&1
</pre>