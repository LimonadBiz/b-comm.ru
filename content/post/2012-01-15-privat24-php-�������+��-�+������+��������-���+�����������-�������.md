---
title: privat24.php — скрипт позволяющий смотреть состояние добавленых в базу Фриинибса карточек VISA/MasterCARD от Приватбанка
author: wel
type: post
date: 2012-01-14T22:19:29+00:00
url: /billing/privat24-php-скрипт-позволяющий-смотреть-сост
wp-syntax-cache-content:
  - |
    a:2:{i:1;s:26958:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?</span>
    <span style="color: #000088;">$TOP</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot; Карточки Клиентов&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$META</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;&lt;META HTTP-EQUIV=<span style="color: #000099; font-weight: bold;">\&quot;</span>Cache-Control<span style="color: #000099; font-weight: bold;">\&quot;</span> CONTENT=<span style="color: #000099; font-weight: bold;">\&quot;</span>no-cache<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;<span style="color: #000099; font-weight: bold;">\n</span>&lt;META HTTP-EQUIV=<span style="color: #000099; font-weight: bold;">\&quot;</span>Pragma<span style="color: #000099; font-weight: bold;">\&quot;</span> CONTENT=<span style="color: #000099; font-weight: bold;">\&quot;</span>no-cache<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #b1b100;">include</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;top.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">include</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;class.loggin.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$log</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Logging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$log</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">setfile</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;privar24.log.html&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;a href='privar24.log.html'&gt;Данные по операциям&lt;/a&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &lt;CENTER&gt;
    &nbsp;
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #000000; font-weight: bold;">function</span> quote_smart<span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">// если magic_quotes_gpc включена - используем stripslashes</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #990000;">get_magic_quotes_gpc</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$value</span> <span style="color: #339933;">=</span> <span style="color: #990000;">stripslashes</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
        <span style="color: #666666; font-style: italic;">// Если переменная - число, то экранировать её не нужно</span>
        <span style="color: #666666; font-style: italic;">// если нет - то окружем её кавычками, и экранируем</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #990000;">is_numeric</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$value</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_real_escape_string</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$value</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$value</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    &nbsp;
    <span style="color: #666666; font-style: italic;">/* коннект к БД - меняем на свое */</span>
    <span style="color: #000088;">$link</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_connect</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'10.200.205.224'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$link</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Could not connect: '</span> <span style="color: #339933;">.</span> <span style="color: #990000;">mysql_error</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;freenibs&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">// Выбираем дни за которые показывать </span>
    <span style="color: #000088;">$card_id</span><span style="color: #339933;">=</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">switch</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'act'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;delete&quot;</span><span style="color: #339933;">:</span>
                <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;DELETE FROM  `privat24` WHERE `id`=&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; LIMIT 1&quot;</span><span style="color: #339933;">;</span>
                    <span style="color: #666666; font-style: italic;">//echo $q;</span>
                    <span style="color: #000088;">$log</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lwrite</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Удалена карта # '</span><span style="color: #339933;">.</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">.</span><span style="color: #0000ff;">' user:'</span><span style="color: #339933;">.</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'user'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">' serial:'</span><span style="color: #339933;">.</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'card'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; &lt;br&gt;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
                    <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                <span style="color: #009900;">&#125;</span>
                <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
        <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;activ&quot;</span><span style="color: #339933;">:</span>
                 <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                      <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;UPDATE `privat24` SET `status`='1' WHERE `id`=&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; LIMIT 1&quot;</span><span style="color: #339933;">;</span>
                      <span style="color: #000088;">$log</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lwrite</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Активирована карта # '</span><span style="color: #339933;">.</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;br&gt;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                       <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                 <span style="color: #009900;">&#125;</span>
                 <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    &nbsp;
        <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;deactiv&quot;</span><span style="color: #339933;">:</span>
                 <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                      <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;UPDATE `privat24` SET `status`='0' WHERE `id`=&quot;</span><span style="color: #339933;">.</span>quote_smart<span style="color: #009900;">&#40;</span><span style="color: #000088;">$card_id</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; LIMIT 1&quot;</span><span style="color: #339933;">;</span>
                       <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                       <span style="color: #000088;">$log</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lwrite</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Деактивирована карта # '</span><span style="color: #339933;">.</span><span style="color: #000088;">$card_id</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;br&gt;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
                 <span style="color: #009900;">&#125;</span>
                 <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;SELECT * FROM `privat24` ORDER BY `status`,`uid`,`t` ASC &quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;SELECT * FROM `privat24` ORDER BY `status`  DESC &quot;</span><span style="color: #339933;">;</span>
    &nbsp;
      <span style="color: #000088;">$result</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #666666; font-style: italic;">//$days=array();</span>
      <span style="color: #000088;">$i</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;table border='1'&gt;
             &lt;td&gt;N&lt;/td&gt;&lt;td&gt;user&lt;/td&gt;&lt;td&gt;card&lt;/td&gt;&lt;td&gt;time&lt;/td&gt;&lt;td&gt;action&lt;/td&gt;&lt;td&gt;status&lt;/td&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #b1b100;">while</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_fetch_array</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$result</span><span style="color: #339933;">,</span> MYSQL_ASSOC<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$i</span><span style="color: #339933;">++;</span>
        <span style="color: #000088;">$s</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'start'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$t</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'stop'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$user</span><span style="color: #339933;">=</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'uid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
        <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'status'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">==</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span>
            <span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'status'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">=</span><span style="color: #0000ff;">'не активно'</span><span style="color: #339933;">;</span>
        <span style="color: #b1b100;">else</span>
                 <span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'status'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">=</span><span style="color: #0000ff;">'активно'</span><span style="color: #339933;">;</span>
        <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot; &lt;tr&gt;
                    &lt;td&gt;<span style="color: #006699; font-weight: bold;">$i</span>&lt;/td&gt;&lt;td&gt;<span style="color: #006699; font-weight: bold;">$user</span>&lt;/td&gt;
                    &lt;td&gt;<span style="color: #006699; font-weight: bold;">$s</span>&quot;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;********&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$t</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
                    &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'t'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
                    &lt;td&gt;&lt;a href='?act=delete&amp;amp;id=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;user=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$user</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;card=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$s</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;_____&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$t</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;'&gt;Удалить&lt;/a&gt;
                    / / &lt;a href='?act=activ&amp;amp;id=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;user=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$user</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;card=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$s</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;_____&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$t</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;'&gt;Активировать&lt;/a&gt;
                    / /  &lt;a href='?act=deactiv&amp;amp;id=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'id'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;user=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$user</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&amp;amp;card=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$s</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;_____&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$t</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;'&gt;Деактивировать&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'status'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
    &nbsp;
               &lt;/tr&gt; &quot;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;/table&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #990000;">mysql_close</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$link</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">&lt;?</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &lt;/CENTER&gt;
    <span style="color: #000000; font-weight: bold;">&lt;?</span>
    <span style="color: #b1b100;">include</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;bottom.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">&lt;?
    $TOP = &quot; Карточки Клиентов&quot;;
    $META = &quot;&lt;META HTTP-EQUIV=\&quot;Cache-Control\&quot; CONTENT=\&quot;no-cache\&quot;&gt;\n&lt;META HTTP-EQUIV=\&quot;Pragma\&quot; CONTENT=\&quot;no-cache\&quot;&gt;&quot;;
    
    include(&quot;top.php&quot;);
    include(&quot;class.loggin.php&quot;);
    $log = new Logging();
    $log-&gt;setfile(&quot;privar24.log.html&quot;);
    echo &quot;&lt;a href='privar24.log.html'&gt;Данные по операциям&lt;/a&gt;&quot;;
    ?&gt;
    &lt;CENTER&gt;
    
    &lt;?php
    function quote_smart($value)
    {
        // если magic_quotes_gpc включена - используем stripslashes
        if (get_magic_quotes_gpc()) {
            $value = stripslashes($value);
        }
        // Если переменная - число, то экранировать её не нужно
        // если нет - то окружем её кавычками, и экранируем
        if (!is_numeric($value)) {
            $value = mysql_real_escape_string($value);
        }
        return $value;
    }
    
    
    /* коннект к БД - меняем на свое */
    $link = mysql_connect('10.200.205.224', 'freenibs', 'freenibs');
    if (!$link) {
        die('Could not connect: ' . mysql_error());
    }
    
    mysql_select_db(&quot;freenibs&quot;);
    // Выбираем дни за которые показывать 
    $card_id=$_GET['id'];
    switch($_GET['act']){
        case &quot;delete&quot;:
                if($card_id&gt;0){
                    $q=&quot;DELETE FROM  `privat24` WHERE `id`=&quot;.quote_smart($card_id).&quot; LIMIT 1&quot;;
                    //echo $q;
                    $log-&gt;lwrite('Удалена карта # '.$card_id.' user:'.$_GET['user'].' serial:'.$_GET['card'].&quot; &lt;br&gt;\n&quot;);
    
                    mysql_query($q);
                }
                break;
        case &quot;activ&quot;:
                 if($card_id&gt;0){
                      $q=&quot;UPDATE `privat24` SET `status`='1' WHERE `id`=&quot;.quote_smart($card_id).&quot; LIMIT 1&quot;;
                      $log-&gt;lwrite('Активирована карта # '.$card_id.&quot;&lt;br&gt;\n&quot;);
                       mysql_query($q);
                 }
                 break;
    
        case &quot;deactiv&quot;:
                 if($card_id&gt;0){
                      $q=&quot;UPDATE `privat24` SET `status`='0' WHERE `id`=&quot;.quote_smart($card_id).&quot; LIMIT 1&quot;;
                       mysql_query($q);
                       $log-&gt;lwrite('Деактивирована карта # '.$card_id.&quot;&lt;br&gt;\n&quot;);
    
                 }
                 break;
    
    }
    $q=&quot;SELECT * FROM `privat24` ORDER BY `status`,`uid`,`t` ASC &quot;;
    $q=&quot;SELECT * FROM `privat24` ORDER BY `status`  DESC &quot;;
    
      $result = mysql_query($q);
      //$days=array();
      $i=0;
    echo &quot;&lt;table border='1'&gt;
             &lt;td&gt;N&lt;/td&gt;&lt;td&gt;user&lt;/td&gt;&lt;td&gt;card&lt;/td&gt;&lt;td&gt;time&lt;/td&gt;&lt;td&gt;action&lt;/td&gt;&lt;td&gt;status&lt;/td&gt;&quot;;
    
    while($row = mysql_fetch_array($result, MYSQL_ASSOC)){
        $i++;
        $s=$row['start'];
        $t=$row['stop'];
        $user=$row['uid'];
        if($row['status']==0)
            $row['status']='не активно';
        else
                 $row['status']='активно';
        echo &quot; &lt;tr&gt;
                    &lt;td&gt;$i&lt;/td&gt;&lt;td&gt;$user&lt;/td&gt;
                    &lt;td&gt;$s&quot;.&quot;********&quot;.$t.&quot;&lt;/td&gt;
                    &lt;td&gt;&quot;.$row['t'].&quot;&lt;/td&gt;
                    &lt;td&gt;&lt;a href='?act=delete&amp;amp;id=&quot;.$row['id'].&quot;&amp;amp;user=&quot;.$user.&quot;&amp;amp;card=&quot;.$s.&quot;_____&quot;.$t.&quot;'&gt;Удалить&lt;/a&gt;
                    / / &lt;a href='?act=activ&amp;amp;id=&quot;.$row['id'].&quot;&amp;amp;user=&quot;.$user.&quot;&amp;amp;card=&quot;.$s.&quot;_____&quot;.$t.&quot;'&gt;Активировать&lt;/a&gt;
                    / /  &lt;a href='?act=deactiv&amp;amp;id=&quot;.$row['id'].&quot;&amp;amp;user=&quot;.$user.&quot;&amp;amp;card=&quot;.$s.&quot;_____&quot;.$t.&quot;'&gt;Деактивировать&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&quot;.$row['status'].&quot;&lt;/td&gt;
    
               &lt;/tr&gt; &quot;;
    }
    echo &quot;&lt;/table&gt;&quot;;
    mysql_close($link);
    ?&gt;
    
    &lt;?
    
    ?&gt;
    &lt;/CENTER&gt;
    &lt;?
    include(&quot;bottom.php&quot;);
    ?&gt;</p></div>
    ";i:2;s:7886:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="php" style="font-family:monospace;">class.loggin.php
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #000000; font-weight: bold;">class</span> Logging<span style="color: #009900;">&#123;</span>
      <span style="color: #666666; font-style: italic;">// define log file</span>
      <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$log_file</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'logfile_cccccc.txt'</span><span style="color: #339933;">;</span>
      <span style="color: #666666; font-style: italic;">// define file pointer</span>
      <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000088;">$fp</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
      <span style="color: #666666; font-style: italic;">// write message to the log file</span>
      <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setfile<span style="color: #009900;">&#40;</span><span style="color: #000088;">$filename</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">log_file</span><span style="color: #339933;">=</span><span style="color: #000088;">$filename</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
      <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> lwrite<span style="color: #009900;">&#40;</span><span style="color: #000088;">$message</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">// if file pointer doesn't exist, then open log file</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fp</span><span style="color: #009900;">&#41;</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lopen</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #666666; font-style: italic;">// define script name</span>
        <span style="color: #000088;">$script_name</span> <span style="color: #339933;">=</span> <span style="color: #990000;">pathinfo</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'PHP_SELF'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> PATHINFO_FILENAME<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #666666; font-style: italic;">// define current time</span>
        <span style="color: #000088;">$time</span> <span style="color: #339933;">=</span> <span style="color: #990000;">date</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'H:i:s'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #666666; font-style: italic;">// write current time, script name and message to the log file</span>
        <span style="color: #990000;">fwrite</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fp</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;<span style="color: #006699; font-weight: bold;">$time</span> (<span style="color: #006699; font-weight: bold;">$script_name</span>) <span style="color: #006699; font-weight: bold;">$message</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
      <span style="color: #666666; font-style: italic;">// open log file</span>
      <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">function</span> lopen<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">// define log file path and name</span>
        <span style="color: #000088;">$lfile</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">log_file</span><span style="color: #339933;">;</span>
        <span style="color: #666666; font-style: italic;">// define the current date (it will be appended to the log file name)</span>
        <span style="color: #000088;">$today</span> <span style="color: #339933;">=</span> <span style="color: #990000;">date</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Y-m-d'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #666666; font-style: italic;">// open log file for writing only; place the file pointer at the end of the file</span>
        <span style="color: #666666; font-style: italic;">// if the file does not exist, attempt to create it</span>
        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fp</span> <span style="color: #339933;">=</span> <span style="color: #990000;">fopen</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lfile</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'a'</span><span style="color: #009900;">&#41;</span> or <span style="color: #990000;">exit</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Can't open <span style="color: #006699; font-weight: bold;">$lfile</span>!&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">class.loggin.php
    &lt;?php
    class Logging{
      // define log file
      private $log_file = 'logfile_cccccc.txt';
      // define file pointer
      private $fp = null;
      // write message to the log file
      public function setfile($filename){
            $this-&gt;log_file=$filename;
      }
      public function lwrite($message){
        // if file pointer doesn't exist, then open log file
        if (!$this-&gt;fp) $this-&gt;lopen();
        // define script name
        $script_name = pathinfo($_SERVER['PHP_SELF'], PATHINFO_FILENAME);
        // define current time
        $time = date('H:i:s');
        // write current time, script name and message to the log file
        fwrite($this-&gt;fp, &quot;$time ($script_name) $message\n&quot;);
      }
      // open log file
      private function lopen(){
        // define log file path and name
        $lfile = $this-&gt;log_file;
        // define the current date (it will be appended to the log file name)
        $today = date('Y-m-d');
        // open log file for writing only; place the file pointer at the end of the file
        // if the file does not exist, attempt to create it
        $this-&gt;fp = fopen($lfile, 'a') or exit(&quot;Can't open $lfile!&quot;);
      }
    }
    ?&gt;</p></div>
    ";}
categories:
  - billing
  - FreeNIBS
tags:
  - freeNIBS

---
privat24.php — скрипт позволяющий смотреть состояние добавленых в базу Фриинибса карточек VISA/MasterCARD от Приватбанка
  
Смотреть дамп базы данных тут: http://b-comm.ru/billing/freenibs-database-sql-dump
  
<!--more-->

<pre lang="php"><?
$TOP = " Карточки Клиентов";
$META = "<META HTTP-EQUIV=\"Cache-Control\" CONTENT=\"no-cache\">\n&lt;META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">";

include("top.php");
include("class.loggin.php");
$log = new Logging();
$log->setfile("privar24.log.html");
echo "

<a href='privar24.log.html'>Данные по операциям</a>";
?>


<CENTER>
  <?php
function quote_smart($value)
{
    // если magic_quotes_gpc включена - используем stripslashes
    if (get_magic_quotes_gpc()) {
        $value = stripslashes($value);
    }
    // Если переменная - число, то экранировать её не нужно
    // если нет - то окружем её кавычками, и экранируем
    if (!is_numeric($value)) {
        $value = mysql_real_escape_string($value);
    }
    return $value;
}


/* коннект к БД - меняем на свое */
$link = mysql_connect('10.200.205.224', 'freenibs', 'freenibs');
if (!$link) {
    die('Could not connect: ' . mysql_error());
}

mysql_select_db("freenibs");
// Выбираем дни за которые показывать 
$card_id=$_GET['id'];
switch($_GET['act']){
    case "delete":
            if($card_id>0){
                  $q="DELETE FROM  `privat24` WHERE `id`=".quote_smart($card_id)." LIMIT 1";
                  //echo $q;
                  $log->lwrite('Удалена карта # '.$card_id.' user:'.$_GET['user'].' serial:'.$_GET['card']." 
  
  <br />\n");
  
                  mysql_query($q);
              }
              break;
      case "activ":
               if($card_id>0){
                    $q="UPDATE `privat24` SET `status`='1' WHERE `id`=".quote_smart($card_id)." LIMIT 1";
                    $log->lwrite('Активирована карта # '.$card_id."<br />\n");
                     mysql_query($q);
               }
               break;
  
      case "deactiv":
               if($card_id>0){
                    $q="UPDATE `privat24` SET `status`='0' WHERE `id`=".quote_smart($card_id)." LIMIT 1";
                     mysql_query($q);
                     $log->lwrite('Деактивирована карта # '.$card_id."<br />\n");
  
               }
               break;
  
  }
  $q="SELECT * FROM `privat24` ORDER BY `status`,`uid`,`t` ASC ";
  $q="SELECT * FROM `privat24` ORDER BY `status`  DESC ";
  
    $result = mysql_query($q);
    //$days=array();
    $i=0;
  echo "
  
  <table border='1'>
    <td>
      N
    </td>
    
    <td>
      user
    </td>
    
    <td>
      card
    </td>
    
    <td>
      time
    </td>
    
    <td>
      action
    </td>
    
    <td>
      status
    </td>";
    
    while($row = mysql_fetch_array($result, MYSQL_ASSOC)){
        $i++;
        $s=$row['start'];
        $t=$row['stop'];
        $user=$row['uid'];
        if($row['status']==0)
            $row['status']='не активно';
        else
                 $row['status']='активно';
        echo " 
    
    <tr>
      <td>
        $i
      </td>
      
      <td>
        $user
      </td>
                      
      
      <td>
        $s"."********".$t."
      </td>
                      
      
      <td>
        ".$row['t']."
      </td>
                      
      
      <td>
        &lt;a href='?act=delete&id=".$row['id']."&user=".$user."&card=".$s."_____".$t."'>Удалить&lt;/a>
                        / / &lt;a href='?act=activ&id=".$row['id']."&user=".$user."&card=".$s."_____".$t."'>Активировать&lt;/a>
                        / /  &lt;a href='?act=deactiv&id=".$row['id']."&user=".$user."&card=".$s."_____".$t."'>Деактивировать&lt;/a>
      </td>
                      
      
      <td>
        ".$row['status']."
      </td>
      
                 
    </tr> ";
    }
    echo "
  </table>";
  mysql_close($link);
  ?>
  
  
  
  <?

?>
  
</CENTER>


<?
include("bottom.php");
?>

</pre>

<pre lang="php">class.loggin.php
<?php
class Logging{
  // define log file
  private $log_file = 'logfile_cccccc.txt';
  // define file pointer
  private $fp = null;
  // write message to the log file
  public function setfile($filename){
        $this->log_file=$filename;
  }
  public function lwrite($message){
    // if file pointer doesn't exist, then open log file
    if (!$this->fp) $this->lopen();
    // define script name
    $script_name = pathinfo($_SERVER['PHP_SELF'], PATHINFO_FILENAME);
    // define current time
    $time = date('H:i:s');
    // write current time, script name and message to the log file
    fwrite($this->fp, "$time ($script_name) $message\n");
  }
  // open log file
  private function lopen(){
    // define log file path and name
    $lfile = $this->log_file;
    // define the current date (it will be appended to the log file name)
    $today = date('Y-m-d');
    // open log file for writing only; place the file pointer at the end of the file
    // if the file does not exist, attempt to create it
    $this->fp = fopen($lfile, 'a') or exit("Can't open $lfile!");
  }
}
?>

</pre>