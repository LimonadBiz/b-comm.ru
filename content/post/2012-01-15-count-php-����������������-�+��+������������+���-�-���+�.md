---
title: count.php — отображение пользователей в Онлайне для FreeNIBS
author: wel
type: post
date: 2012-01-14T23:33:12+00:00
url: /billing/count-php-отображение-пользователей-в-онла
wp-syntax-cache-content:
  - |
    a:1:{i:1;s:51863:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="php" style="font-family:monospace;">&nbsp;
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    <span style="color: #000000; font-weight: bold;">function</span> ret_speed_<span style="color: #009900;">&#40;</span><span style="color: #000088;">$speed</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
       <span style="color: #000088;">$pref</span><span style="color: #339933;">=</span><span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
    &nbsp;
        <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$speed</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
            <span style="color: #000088;">$t</span><span style="color: #339933;">=</span><span style="color: #990000;">round</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$speed</span><span style="color: #339933;">/</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
            <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$t</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span>
                <span style="color: #000088;">$t</span><span style="color: #339933;">=</span><span style="color: #990000;">round</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$speed</span><span style="color: #339933;">/</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$t</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span>
                    <span style="color: #000088;">$t</span><span style="color: #339933;">=</span><span style="color: #990000;">round</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$speed</span><span style="color: #339933;">/</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                     <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$t</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
                         <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span>
    &nbsp;
                     <span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span><span style="color: #009900;">&#123;</span>
                          <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span><span style="color: #000088;">$pref</span><span style="color: #339933;">=</span><span style="color: #0000ff;">'G'</span><span style="color: #339933;">;</span>
                     <span style="color: #009900;">&#125;</span>
    &nbsp;
    &nbsp;
    &nbsp;
                <span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span><span style="color: #009900;">&#123;</span>
                    <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span><span style="color: #000088;">$pref</span><span style="color: #339933;">=</span><span style="color: #0000ff;">'M'</span><span style="color: #339933;">;</span>
                <span style="color: #009900;">&#125;</span>
    &nbsp;
            <span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span><span style="color: #009900;">&#123;</span>
                <span style="color: #000088;">$speed</span><span style="color: #339933;">=</span><span style="color: #000088;">$t</span><span style="color: #339933;">;</span>
                <span style="color: #000088;">$pref</span><span style="color: #339933;">=</span><span style="color: #0000ff;">'K'</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">&#125;</span>
    &nbsp;
       <span style="color: #009900;">&#125;</span>
            <span style="color: #b1b100;">return</span> <span style="color: #000088;">$speed</span><span style="color: #339933;">.</span><span style="color: #000088;">$pref</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;bit/s&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #000088;">$TOP</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot; Speed of users&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$META</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;&lt;META HTTP-EQUIV=<span style="color: #000099; font-weight: bold;">\&quot;</span>Refresh<span style="color: #000099; font-weight: bold;">\&quot;</span> CONTENT=<span style="color: #000099; font-weight: bold;">\&quot;</span>60<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;<span style="color: #000099; font-weight: bold;">\n</span>&lt;META HTTP-EQUIV=<span style="color: #000099; font-weight: bold;">\&quot;</span>Cache-Control<span style="color: #000099; font-weight: bold;">\&quot;</span> CONTENT=<span style="color: #000099; font-weight: bold;">\&quot;</span>no-cache<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;<span style="color: #000099; font-weight: bold;">\n</span>&lt;META HTTP-EQUIV=<span style="color: #000099; font-weight: bold;">\&quot;</span>Pragma<span style="color: #000099; font-weight: bold;">\&quot;</span> CONTENT=<span style="color: #000099; font-weight: bold;">\&quot;</span>no-cache<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #b1b100;">include</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;top.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &lt;CENTER&gt;
    &nbsp;
    <span style="color: #000000; font-weight: bold;">&lt;?php</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">/* коннект к БД - меняем на свое */</span>
    <span style="color: #000088;">$link</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_connect</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'10.200.205.224'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'freenibs'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$link</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #990000;">die</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Could not connect: '</span> <span style="color: #339933;">.</span> <span style="color: #990000;">mysql_error</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #990000;">mysql_select_db</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;freenibs&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;SELECT *,`in_speed`,ip AS `ip4` FROM `speed_counter` WHERE `interface`!='' &quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;SELECT
        `speed_counter`.`gid`,
        `packets`.`packet`,
        `speed_counter`.`user`,
        `speed_counter`.`in_speed`,
        `speed_counter`.`all_last`,
        `speed_counter`.`in_last`,
        `speed_counter`.`out_last`,
        `speed_counter`.`all_speed`,
        `speed_counter`.`out_speed`,
        `speed_counter`.`in_load`,
        `speed_counter`.`out_load`,
        `speed_counter`.`interface`,
        `speed_counter`.`speed_car_in`,
        `speed_counter`.`speed_car_out`,
    &nbsp;
         `speed_counter`.`ip`  AS `ip4`
    FROM `speed_counter`
    LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
    LEFT JOIN `packets` ON `users`.`gid` = `packets`.`gid`
    WHERE
        `interface` != ''
    &quot;</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">/*
     * $q=&quot;SELECT
    INET_NTOA(ip) AS `ip4`,`all_last`,`in_last`,`out_last`,`time_last`,`all_speed`,`in_speed`,`out_speed`,`in_load`,
    `out_load`,`interface`,`speed_car_in`,`speed_car_out`,`gid`,`user`,`uid`
     FROM `speed_counter`
    WHERE
        `interface` != ''
      &quot;;
    */</span>
    &nbsp;
    <span style="color: #b1b100;">switch</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'type'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;all_speed&quot;</span><span style="color: #339933;">:</span>
            <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `all_speed` DESC&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;node&quot;</span><span style="color: #339933;">:</span>
             <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `interface`  DESC&quot;</span><span style="color: #339933;">;</span>
             <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;packet&quot;</span><span style="color: #339933;">:</span>
            <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `packets`.`gid` DESC&quot;</span><span style="color: #339933;">;</span>
            <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'gid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">&gt;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span>
    &nbsp;
                <span style="color: #000088;">$q</span><span style="color: #339933;">=</span><span style="color: #0000ff;">&quot;SELECT
                    `packets`.`gid`,
                    `packets`.`packet`,
                    `users`.`user`,
                    `speed_counter`.`in_speed`,
                    `speed_counter`.`all_last`,
                    `speed_counter`.`in_last`,
                    `speed_counter`.`out_last`,
                    `speed_counter`.`all_speed`,
                    `speed_counter`.`out_speed`,
                    `speed_counter`.`in_load`,
                    `speed_counter`.`out_load`,
                    `speed_counter`.`interface`,
                    `speed_counter`.`speed_car_in`,
                    `speed_counter`.`speed_car_out`,
    &nbsp;
                      `speed_counter`.`ip`  AS `ip4`
    &nbsp;
                  FROM `speed_counter`
                      LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
                      INNER JOIN `packets` ON (`users`.`gid` = `packets`.`gid` AND `packets`.`gid`='&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$_GET</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'gid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;')
                      WHERE `interface` != ''
                     ORDER by `all_speed` DESC                                &quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    &nbsp;
            <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;in_speed&quot;</span><span style="color: #339933;">:</span>
           <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `in_speed`  DESC&quot;</span><span style="color: #339933;">;</span>
     <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;out_speed&quot;</span><span style="color: #339933;">:</span>
              <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `out_speed`  DESC&quot;</span><span style="color: #339933;">;</span>
               <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
     <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;in_load&quot;</span><span style="color: #339933;">:</span>
             <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `in_load`  DESC&quot;</span><span style="color: #339933;">;</span>
              <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
      <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;all_last&quot;</span><span style="color: #339933;">:</span>
             <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `all_last`  DESC&quot;</span><span style="color: #339933;">;</span>
               <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    &nbsp;
     <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;out_load&quot;</span><span style="color: #339933;">:</span>
             <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `out_load`  DESC&quot;</span><span style="color: #339933;">;</span>
           <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
      <span style="color: #b1b100;">case</span> <span style="color: #0000ff;">&quot;ip&quot;</span><span style="color: #339933;">:</span>
             <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `ip`  DESC&quot;</span><span style="color: #339933;">;</span>
              <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    &nbsp;
     <span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
    &nbsp;
        <span style="color: #000088;">$q</span><span style="color: #339933;">.=</span><span style="color: #0000ff;">&quot; ORDER by `all_speed` DESC&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span>
     <span style="color: #666666; font-style: italic;">// echo $q;</span>
    &nbsp;
    <span style="color: #666666; font-style: italic;">//$q=&quot;SELECT *,`in_speed`,INET_NTOA(ip) AS `ip4` FROM `speed_counter` ORDER by `in_speed` DESC&quot;;</span>
    &nbsp;
    <span style="color: #000088;">$result</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_query</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$q</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$n</span><span style="color: #339933;">=</span><span style="color: #990000;">mysql_num_rows</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$result</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;Online:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$n</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;table border=1&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;tr&gt;
        &lt;td&gt;&lt;a href='?type=packet'&gt;Пакет&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=login'&gt;login&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=all_speed'&gt;Общая скорость&lt;/a&gt;&lt;br&gt;Вход+Исход&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=ip'&gt;ip&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=node'&gt;Интерфейс&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;Стоит скорость: Вход / Исход&lt;/td&gt;
    &nbsp;
        &lt;td&gt;Траффик: &lt;br&gt;  &lt;a href='?type=all_last'&gt;Весь&lt;/a&gt; / &lt;a href='?type=in_last'&gt;Вход&lt;/a&gt; / &lt;a href='?type=out_last'&gt;Исход&lt;/a&gt; &lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=in_speed'&gt;Входящая скорость&lt;/a&gt;&lt;br&gt;&lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=out_speed'&gt;Исходящая скорость&lt;/a&gt;&lt;br&gt;(Kb/s)&lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=in_load'&gt;Входящая&lt;/a&gt;&lt;br&gt; скорость &lt;br&gt;за сессию&lt;br&gt; (Kb/s)&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=out_load'&gt;Исходящая&lt;/a&gt;&lt;br&gt; скорость &lt;br&gt;за сессию&lt;br&gt; (Kb/s)&lt;/td&gt;&lt;/tr&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$out_speed_sum</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span><span style="color: #000088;">$out_load_sum</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$in_speed_sum</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$str</span><span style="color: #339933;">=</span><span style="color: #0000ff;">''</span><span style="color: #339933;">;</span><span style="color: #000088;">$str1</span><span style="color: #339933;">=</span><span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span> <span style="color: #339933;">=</span> <span style="color: #990000;">mysql_fetch_array</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$result</span><span style="color: #339933;">,</span> MYSQL_ASSOC<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000088;">$out_speed</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>out_speed<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
     <span style="color: #000088;">$in_speed</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>in_speed<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$in</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>out_last<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #339933;">*</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$out</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>in_last<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #339933;">*</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$in_load</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>in_load<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$all_speed</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>all_speed<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$out_load</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>out_load<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$all</span><span style="color: #339933;">=</span><span style="color: #990000;">ceil</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>all_last<span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1024</span><span style="color: #339933;">*</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>ip4<span style="color: #009900;">&#93;</span><span style="color: #339933;">!=</span><span style="color: #0000ff;">'10.200.205.2'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #000088;">$out_speed_sum</span><span style="color: #339933;">=</span><span style="color: #000088;">$out_speed_sum</span><span style="color: #339933;">+</span><span style="color: #000088;">$out_speed</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$out_load_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$out_load</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$in_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$in</span><span style="color: #339933;">;</span>
     <span style="color: #000088;">$all_speed_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$all_speed</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$in_speed_sum</span><span style="color: #339933;">=</span><span style="color: #000088;">$in_speed_sum</span><span style="color: #339933;">+</span><span style="color: #000088;">$in_speed</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$in_load_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$in_load</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$out_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$out</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$all_sum</span><span style="color: #339933;">+=</span><span style="color: #000088;">$all</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #000088;">$str</span><span style="color: #339933;">.=</span> <span style="color: #0000ff;">&quot;&lt;tr&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'gid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;a href='?type=packet&amp;gid=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'gid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;'&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>packet<span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a target=<span style="color: #000099; font-weight: bold;">\&quot;</span>_blank<span style="color: #000099; font-weight: bold;">\&quot;</span> href=<span style="color: #000099; font-weight: bold;">\&quot;</span>https://home/abills/admin/index.cgi?index=7&amp;search=1&amp;type=11&amp;LOGIN_EXPR=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'user'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\&quot;</span>&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'user'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all_speed</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kbit/s&lt;/td&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'ip4'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
         &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'interface'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
        <span style="color: #666666; font-style: italic;">//$str.= &quot;&lt;td&gt;&quot;.(ceil($row['speed_car_in']/(1024*1024))).&quot;Mbits / &quot;.ceil(($row['speed_car_out']/(1024*1024))).&quot;Mbits &lt;/td&gt;&quot;;</span>
        <span style="color: #666666; font-style: italic;">//ret_speed_(</span>
        <span style="color: #000088;">$str</span><span style="color: #339933;">.=</span> <span style="color: #0000ff;">&quot;&lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span>ret_speed_<span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'speed_car_in'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot; / &quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span>ret_speed_<span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'speed_car_out'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;  &lt;/td&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
        <span style="color: #000088;">$str</span><span style="color: #339933;">.=</span> <span style="color: #0000ff;">&quot;&lt;td&gt; all: &quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb/ in:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb /out:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_speed</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_speed</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_load</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_load</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
      &lt;/tr&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #009900;">&#125;</span>
    &nbsp;
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>ip4<span style="color: #009900;">&#93;</span><span style="color: #339933;">==</span><span style="color: #0000ff;">'10.200.205.2'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    &nbsp;
    <span style="color: #000088;">$str1</span><span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;&lt;tr&gt;
        &lt;td&gt;&lt;a href='?type=packet&amp;gid=&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'gid'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;'&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span>packet<span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;a&gt;&lt;/td&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'user'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all_speed</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
        &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'ip4'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
         &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'interface'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
         &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'speed_car_in'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kbits / &quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$row</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'speed_car_out'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">/</span><span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kbits &lt;/td&gt;
        &lt;td&gt; all: &quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb/ in:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb /out:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_speed</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_speed</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_load</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
        &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_load</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
      &lt;/tr&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #000088;">$str1</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #000088;">$str</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;tr&gt;
            &lt;td&gt;Итог:&lt;/td&gt;
            &lt;td&gt;&lt;/td&gt;
            &lt;td&gt;&quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all_speed_sum</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
            &lt;td&gt;ip&lt;/td&gt;
            &lt;td&gt;interface&lt;/td&gt;
            &lt;td&gt; all: &quot;</span><span style="color: #339933;">.</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$all_sum</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb/ in:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb /out:&quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Mb&lt;/td&gt;
            &lt;td&gt;&lt;/td&gt;
             &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_speed_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
             &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_speed_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;Kb/s&lt;/td&gt;
             &lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$in_load_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;&lt;td&gt; &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$out_load_sum</span><span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/td&gt;
              &lt;/tr&gt;&quot;</span><span style="color: #339933;">;</span>
    &nbsp;
    <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;/table&gt;&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #990000;">mysql_close</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$link</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">&lt;?</span>
    &nbsp;
    <span style="color: #000000; font-weight: bold;">?&gt;</span>
    &lt;/CENTER&gt;
    <span style="color: #000000; font-weight: bold;">&lt;?</span>
    <span style="color: #b1b100;">include</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;bottom.php&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">
    &lt;?php
    function ret_speed_($speed){
       $pref='';
    
        if($speed&gt;1024){
            $t=round(($speed/1024),2);
            if($t&gt;1024){
                $speed=$t;
                $t=round(($speed/1024),2);
                if($t&gt;1024){
                    $speed=$t;
                    $t=round(($speed/1024),2);
                     if($t&gt;1024){
                         $speed=$t;
    
                     }else{
                          $speed=$t;$pref='G';
                     }
    
    
    
                }else{
                    $speed=$t;$pref='M';
                }
    
            }else{
                $speed=$t;
                $pref='K';
            }
    
       }
            return $speed.$pref.&quot;bit/s&quot;;
    
    }
    
    $TOP = &quot; Speed of users&quot;;
    $META = &quot;&lt;META HTTP-EQUIV=\&quot;Refresh\&quot; CONTENT=\&quot;60\&quot;&gt;\n&lt;META HTTP-EQUIV=\&quot;Cache-Control\&quot; CONTENT=\&quot;no-cache\&quot;&gt;\n&lt;META HTTP-EQUIV=\&quot;Pragma\&quot; CONTENT=\&quot;no-cache\&quot;&gt;&quot;;
    
    include(&quot;top.php&quot;);
    ?&gt;
    &lt;CENTER&gt;
    
    &lt;?php
    
    /* коннект к БД - меняем на свое */
    $link = mysql_connect('10.200.205.224', 'freenibs', 'freenibs');
    if (!$link) {
        die('Could not connect: ' . mysql_error());
    }
    
    mysql_select_db(&quot;freenibs&quot;);
    $q=&quot;SELECT *,`in_speed`,ip AS `ip4` FROM `speed_counter` WHERE `interface`!='' &quot;;
    
    $q=&quot;SELECT
        `speed_counter`.`gid`,
        `packets`.`packet`,
        `speed_counter`.`user`,
        `speed_counter`.`in_speed`,
        `speed_counter`.`all_last`,
        `speed_counter`.`in_last`,
        `speed_counter`.`out_last`,
        `speed_counter`.`all_speed`,
        `speed_counter`.`out_speed`,
        `speed_counter`.`in_load`,
        `speed_counter`.`out_load`,
        `speed_counter`.`interface`,
        `speed_counter`.`speed_car_in`,
        `speed_counter`.`speed_car_out`,
    
         `speed_counter`.`ip`  AS `ip4`
    FROM `speed_counter`
    LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
    LEFT JOIN `packets` ON `users`.`gid` = `packets`.`gid`
    WHERE
        `interface` != ''
    &quot;;
    /*
     * $q=&quot;SELECT
    INET_NTOA(ip) AS `ip4`,`all_last`,`in_last`,`out_last`,`time_last`,`all_speed`,`in_speed`,`out_speed`,`in_load`,
    `out_load`,`interface`,`speed_car_in`,`speed_car_out`,`gid`,`user`,`uid`
     FROM `speed_counter`
    WHERE
        `interface` != ''
      &quot;;
    */
    
    switch($_GET['type']){
    case &quot;all_speed&quot;:
            $q.=&quot; ORDER by `all_speed` DESC&quot;;
    break;
    case &quot;node&quot;:
             $q.=&quot; ORDER by `interface`  DESC&quot;;
             break;
    case &quot;packet&quot;:
            $q.=&quot; ORDER by `packets`.`gid` DESC&quot;;
            if($_GET['gid']&gt;0)
    
                $q=&quot;SELECT
                    `packets`.`gid`,
                    `packets`.`packet`,
                    `users`.`user`,
                    `speed_counter`.`in_speed`,
                    `speed_counter`.`all_last`,
                    `speed_counter`.`in_last`,
                    `speed_counter`.`out_last`,
                    `speed_counter`.`all_speed`,
                    `speed_counter`.`out_speed`,
                    `speed_counter`.`in_load`,
                    `speed_counter`.`out_load`,
                    `speed_counter`.`interface`,
                    `speed_counter`.`speed_car_in`,
                    `speed_counter`.`speed_car_out`,
    
                      `speed_counter`.`ip`  AS `ip4`
    
                  FROM `speed_counter`
                      LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
                      INNER JOIN `packets` ON (`users`.`gid` = `packets`.`gid` AND `packets`.`gid`='&quot;.$_GET['gid'].&quot;')
                      WHERE `interface` != ''
                     ORDER by `all_speed` DESC                                &quot;;
    
    
            break;
    case &quot;in_speed&quot;:
           $q.=&quot; ORDER by `in_speed`  DESC&quot;;
     break;
    case &quot;out_speed&quot;:
              $q.=&quot; ORDER by `out_speed`  DESC&quot;;
               break;
     case &quot;in_load&quot;:
             $q.=&quot; ORDER by `in_load`  DESC&quot;;
              break;
      case &quot;all_last&quot;:
             $q.=&quot; ORDER by `all_last`  DESC&quot;;
               break;
    
     case &quot;out_load&quot;:
             $q.=&quot; ORDER by `out_load`  DESC&quot;;
           break;
      case &quot;ip&quot;:
             $q.=&quot; ORDER by `ip`  DESC&quot;;
              break;
    
     default:
    
        $q.=&quot; ORDER by `all_speed` DESC&quot;;
    break;
    
    }
     // echo $q;
    
    //$q=&quot;SELECT *,`in_speed`,INET_NTOA(ip) AS `ip4` FROM `speed_counter` ORDER by `in_speed` DESC&quot;;
    
    $result = mysql_query($q);
    $n=mysql_num_rows($result);
    echo &quot;Online:&quot;.$n;
    echo &quot;&lt;table border=1&gt;&quot;;
    echo &quot;&lt;tr&gt;
        &lt;td&gt;&lt;a href='?type=packet'&gt;Пакет&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=login'&gt;login&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=all_speed'&gt;Общая скорость&lt;/a&gt;&lt;br&gt;Вход+Исход&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=ip'&gt;ip&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=node'&gt;Интерфейс&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;Стоит скорость: Вход / Исход&lt;/td&gt;
    
        &lt;td&gt;Траффик: &lt;br&gt;  &lt;a href='?type=all_last'&gt;Весь&lt;/a&gt; / &lt;a href='?type=in_last'&gt;Вход&lt;/a&gt; / &lt;a href='?type=out_last'&gt;Исход&lt;/a&gt; &lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=in_speed'&gt;Входящая скорость&lt;/a&gt;&lt;br&gt;&lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=out_speed'&gt;Исходящая скорость&lt;/a&gt;&lt;br&gt;(Kb/s)&lt;/td&gt;
        &lt;td&gt; &lt;a href='?type=in_load'&gt;Входящая&lt;/a&gt;&lt;br&gt; скорость &lt;br&gt;за сессию&lt;br&gt; (Kb/s)&lt;/td&gt;
        &lt;td&gt;&lt;a href='?type=out_load'&gt;Исходящая&lt;/a&gt;&lt;br&gt; скорость &lt;br&gt;за сессию&lt;br&gt; (Kb/s)&lt;/td&gt;&lt;/tr&gt;&quot;;
    $out_speed_sum=0;$out_load_sum=0;
    $in_speed_sum=0;
    $str='';$str1='';
    while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) {
    $out_speed=ceil($row[out_speed]/(1024));
     $in_speed=ceil($row[in_speed]/(1024));
    
    $in=ceil($row[out_last]/(1024*1024));
    $out=ceil($row[in_last]/(1024*1024));
    
    $in_load=ceil($row[in_load]/(1024));
    $all_speed=ceil($row[all_speed]/(1024));
    $out_load=ceil($row[out_load]/(1024));
    $all=ceil($row[all_last]/(1024*1024));
    
    if(($row[ip4]!='10.200.205.2') ){
    $out_speed_sum=$out_speed_sum+$out_speed;
    $out_load_sum+=$out_load;
    $in_sum+=$in;
     $all_speed_sum+=$all_speed;
    $in_speed_sum=$in_speed_sum+$in_speed;
    $in_load_sum+=$in_load;
    $out_sum+=$out;
    $all_sum+=$all;
    
    $str.= &quot;&lt;tr&gt;
        &lt;td&gt;&quot;.$row['gid'].&quot;&lt;a href='?type=packet&amp;gid=&quot;.$row['gid'].&quot;'&gt;&quot;.$row[packet].&quot;&lt;a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a target=\&quot;_blank\&quot; href=\&quot;https://home/abills/admin/index.cgi?index=7&amp;search=1&amp;type=11&amp;LOGIN_EXPR=&quot;.$row['user'].&quot;\&quot;&gt;&quot;.$row['user'].&quot;&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&quot;.($all_speed).&quot;Kbit/s&lt;/td&gt;
        &lt;td&gt;&quot;.$row['ip4'].&quot;&lt;/td&gt;
         &lt;td&gt;&quot;.$row['interface'].&quot;&lt;/td&gt;&quot;;
    
        //$str.= &quot;&lt;td&gt;&quot;.(ceil($row['speed_car_in']/(1024*1024))).&quot;Mbits / &quot;.ceil(($row['speed_car_out']/(1024*1024))).&quot;Mbits &lt;/td&gt;&quot;;
        //ret_speed_(
        $str.= &quot;&lt;td&gt;&quot;.(ret_speed_($row['speed_car_in'])).&quot; / &quot;.(ret_speed_($row['speed_car_out'])).&quot;  &lt;/td&gt;&quot;;
    
        $str.= &quot;&lt;td&gt; all: &quot;.($all).&quot;Mb/ in:&quot;.$in.&quot;Mb /out:&quot;.$out.&quot;Mb&lt;/td&gt;
        &lt;td&gt; &quot;.$in_speed.&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;.$out_speed.&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;.$in_load.&quot;&lt;/td&gt;
        &lt;td&gt; &quot;.$out_load.&quot;&lt;/td&gt;
      &lt;/tr&gt;&quot;;
    
    }
    
    if(($row[ip4]=='10.200.205.2') ){
    
    $str1= &quot;&lt;tr&gt;
        &lt;td&gt;&lt;a href='?type=packet&amp;gid=&quot;.$row['gid'].&quot;'&gt;&quot;.$row[packet].&quot;&lt;a&gt;&lt;/td&gt;
        &lt;td&gt;&quot;.$row['user'].&quot;&lt;/td&gt;
        &lt;td&gt;&quot;.($all_speed).&quot;Kb/s&lt;/td&gt;
        &lt;td&gt;&quot;.$row['ip4'].&quot;&lt;/td&gt;
         &lt;td&gt;&quot;.$row['interface'].&quot;&lt;/td&gt;
         &lt;td&gt;&quot;.($row['speed_car_in']/1024).&quot;Kbits / &quot;.($row['speed_car_out']/1024).&quot;Kbits &lt;/td&gt;
        &lt;td&gt; all: &quot;.($all).&quot;Mb/ in:&quot;.$in.&quot;Mb /out:&quot;.$out.&quot;Mb&lt;/td&gt;
        &lt;td&gt; &quot;.$in_speed.&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;.$out_speed.&quot;Kb/s&lt;/td&gt;
        &lt;td&gt; &quot;.$in_load.&quot;&lt;/td&gt;
        &lt;td&gt; &quot;.$out_load.&quot;&lt;/td&gt;
      &lt;/tr&gt;&quot;;
    }
    }
    echo $str1;
    echo $str;
    echo &quot;&lt;tr&gt;
            &lt;td&gt;Итог:&lt;/td&gt;
            &lt;td&gt;&lt;/td&gt;
            &lt;td&gt;&quot;.($all_speed_sum).&quot;Kb/s&lt;/td&gt;
            &lt;td&gt;ip&lt;/td&gt;
            &lt;td&gt;interface&lt;/td&gt;
            &lt;td&gt; all: &quot;.($all_sum).&quot;Mb/ in:&quot;.$in_sum.&quot;Mb /out:&quot;.$out_sum.&quot;Mb&lt;/td&gt;
            &lt;td&gt;&lt;/td&gt;
             &lt;td&gt; &quot;.$in_speed_sum.&quot;Kb/s&lt;/td&gt;
             &lt;td&gt; &quot;.$out_speed_sum.&quot;Kb/s&lt;/td&gt;
             &lt;td&gt; &quot;.$in_load_sum.&quot;&lt;/td&gt;&lt;td&gt; &quot;.$out_load_sum.&quot;&lt;/td&gt;
              &lt;/tr&gt;&quot;;
    
    echo &quot;&lt;/table&gt;&quot;;
    mysql_close($link);
    ?&gt;
    
    &lt;?
    
    ?&gt;
    &lt;/CENTER&gt;
    &lt;?
    include(&quot;bottom.php&quot;);
    ?&gt;</p></div>
    ";}
categories:
  - billing
  - FreeNIBS
tags:
  - count.php
  - freeNIBS

---
count.php — отображение пользователей в Онлайне для FreeNIBS<!--more-->

<pre lang="php"><?php
function ret_speed_($speed){
   $pref='';

    if($speed>1024){
        $t=round(($speed/1024),2);
        if($t>1024){
            $speed=$t;
            $t=round(($speed/1024),2);
            if($t>1024){
                $speed=$t;
                $t=round(($speed/1024),2);
                 if($t>1024){
                     $speed=$t;

                 }else{
                      $speed=$t;$pref='G';
                 }



            }else{
                $speed=$t;$pref='M';
            }

        }else{
            $speed=$t;
            $pref='K';
        }

   }
        return $speed.$pref."bit/s";

}

$TOP = " Speed of users";
$META = "<META HTTP-EQUIV=\"Refresh\" CONTENT=\"60\">\n<META HTTP-EQUIV=\"Cache-Control\" CONTENT=\"no-cache\">\n<META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">";

include("top.php");
?>


<CENTER>
  <?php

/* коннект к БД - меняем на свое */
$link = mysql_connect('10.200.205.224', 'freenibs', 'freenibs');
if (!$link) {
    die('Could not connect: ' . mysql_error());
}

mysql_select_db("freenibs");
$q="SELECT *,`in_speed`,ip AS `ip4` FROM `speed_counter` WHERE `interface`!='' ";

$q="SELECT
    `speed_counter`.`gid`,
    `packets`.`packet`,
    `speed_counter`.`user`,
    `speed_counter`.`in_speed`,
    `speed_counter`.`all_last`,
    `speed_counter`.`in_last`,
    `speed_counter`.`out_last`,
    `speed_counter`.`all_speed`,
    `speed_counter`.`out_speed`,
    `speed_counter`.`in_load`,
    `speed_counter`.`out_load`,
    `speed_counter`.`interface`,
    `speed_counter`.`speed_car_in`,
    `speed_counter`.`speed_car_out`,

     `speed_counter`.`ip`  AS `ip4`
FROM `speed_counter`
LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
LEFT JOIN `packets` ON `users`.`gid` = `packets`.`gid`
WHERE
    `interface` != ''
";
/*
 * $q="SELECT
INET_NTOA(ip) AS `ip4`,`all_last`,`in_last`,`out_last`,`time_last`,`all_speed`,`in_speed`,`out_speed`,`in_load`,
`out_load`,`interface`,`speed_car_in`,`speed_car_out`,`gid`,`user`,`uid`
 FROM `speed_counter`
WHERE
    `interface` != ''
  ";
*/

switch($_GET['type']){
case "all_speed":
        $q.=" ORDER by `all_speed` DESC";
break;
case "node":
         $q.=" ORDER by `interface`  DESC";
         break;
case "packet":
        $q.=" ORDER by `packets`.`gid` DESC";
        if($_GET['gid']>0)
  
              $q="SELECT
                  `packets`.`gid`,
                  `packets`.`packet`,
                  `users`.`user`,
                  `speed_counter`.`in_speed`,
                  `speed_counter`.`all_last`,
                  `speed_counter`.`in_last`,
                  `speed_counter`.`out_last`,
                  `speed_counter`.`all_speed`,
                  `speed_counter`.`out_speed`,
                  `speed_counter`.`in_load`,
                  `speed_counter`.`out_load`,
                  `speed_counter`.`interface`,
                  `speed_counter`.`speed_car_in`,
                  `speed_counter`.`speed_car_out`,
  
                    `speed_counter`.`ip`  AS `ip4`
  
                FROM `speed_counter`
                    LEFT JOIN `users` ON `users`.`framed_ip` = `speed_counter`.`ip`
                    INNER JOIN `packets` ON (`users`.`gid` = `packets`.`gid` AND `packets`.`gid`='".$_GET['gid']."')
                    WHERE `interface` != ''
                   ORDER by `all_speed` DESC                                ";
  
  
          break;
  case "in_speed":
         $q.=" ORDER by `in_speed`  DESC";
   break;
  case "out_speed":
            $q.=" ORDER by `out_speed`  DESC";
             break;
   case "in_load":
           $q.=" ORDER by `in_load`  DESC";
            break;
    case "all_last":
           $q.=" ORDER by `all_last`  DESC";
             break;
  
   case "out_load":
           $q.=" ORDER by `out_load`  DESC";
         break;
    case "ip":
           $q.=" ORDER by `ip`  DESC";
            break;
  
   default:
  
      $q.=" ORDER by `all_speed` DESC";
  break;
  
  }
   // echo $q;
  
  //$q="SELECT *,`in_speed`,INET_NTOA(ip) AS `ip4` FROM `speed_counter` ORDER by `in_speed` DESC";
  
  $result = mysql_query($q);
  $n=mysql_num_rows($result);
  echo "Online:".$n;
  echo "<table border=1>";
  echo "
  
  <tr>
    <td>
      <a href='?type=packet'>Пакет</a>
    </td>
        
    
    <td>
      <a href='?type=login'>login</a>
    </td>
        
    
    <td>
      <a href='?type=all_speed'>Общая скорость</a><br />Вход+Исход
    </td>
        
    
    <td>
      <a href='?type=ip'>ip</a>
    </td>
        
    
    <td>
      <a href='?type=node'>Интерфейс</a>
    </td>
        
    
    <td>
      Стоит скорость: Вход / Исход
    </td>
    
        
    
    <td>
      Траффик: <br />  <a href='?type=all_last'>Весь</a> / <a href='?type=in_last'>Вход</a> / <a href='?type=out_last'>Исход</a> 
    </td>
        
    
    <td>
      <a href='?type=in_speed'>Входящая скорость</a><br />
    </td>
        
    
    <td>
      <a href='?type=out_speed'>Исходящая скорость</a><br />(Kb/s)
    </td>
        
    
    <td>
      <a href='?type=in_load'>Входящая</a><br /> скорость <br />за сессию<br /> (Kb/s)
    </td>
        
    
    <td>
      <a href='?type=out_load'>Исходящая</a><br /> скорость <br />за сессию<br /> (Kb/s)
    </td>
  </tr>";
  $out_speed_sum=0;$out_load_sum=0;
  $in_speed_sum=0;
  $str='';$str1='';
  while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) {
  $out_speed=ceil($row[out_speed]/(1024));
   $in_speed=ceil($row[in_speed]/(1024));
  
  $in=ceil($row[out_last]/(1024*1024));
  $out=ceil($row[in_last]/(1024*1024));
  
  $in_load=ceil($row[in_load]/(1024));
  $all_speed=ceil($row[all_speed]/(1024));
  $out_load=ceil($row[out_load]/(1024));
  $all=ceil($row[all_last]/(1024*1024));
  
  if(($row[ip4]!='10.200.205.2') ){
  $out_speed_sum=$out_speed_sum+$out_speed;
  $out_load_sum+=$out_load;
  $in_sum+=$in;
   $all_speed_sum+=$all_speed;
  $in_speed_sum=$in_speed_sum+$in_speed;
  $in_load_sum+=$in_load;
  $out_sum+=$out;
  $all_sum+=$all;
  
  $str.= "
  
  <tr>
    <td>
      ".$row['gid']."<a href='?type=packet&#038;gid=".$row['gid']."'>".$row[packet]."<a></td>
          
      
      <td>
        <a target=\"_blank\" href=\"https://home/abills/admin/index.cgi?index=7&#038;search=1&#038;type=11&#038;LOGIN_EXPR=".$row['user']."\">".$row['user']."</a>
      </td>
          
      
      <td>
        ".($all_speed)."Kbit/s
      </td>
          
      
      <td>
        ".$row['ip4']."
      </td>
           
      
      <td>
        ".$row['interface']."
      </td>";
      
          //$str.= "
      
      <td>
        ".(ceil($row['speed_car_in']/(1024*1024)))."Mbits / ".ceil(($row['speed_car_out']/(1024*1024)))."Mbits 
      </td>";
          //ret_speed_(
          $str.= "
      
      <td>
        ".(ret_speed_($row['speed_car_in']))." / ".(ret_speed_($row['speed_car_out']))."  
      </td>";
      
          $str.= "
      
      <td>
        all: ".($all)."Mb/ in:".$in."Mb /out:".$out."Mb
      </td>
          
      
      <td>
        ".$in_speed."Kb/s
      </td>
          
      
      <td>
        ".$out_speed."Kb/s
      </td>
          
      
      <td>
        ".$in_load."
      </td>
          
      
      <td>
        ".$out_load."
      </td>
        </tr>";
      
      }
      
      if(($row[ip4]=='10.200.205.2') ){
      
      $str1= "
      
      <tr>
        <td>
          <a href='?type=packet&#038;gid=".$row['gid']."'>".$row[packet]."<a></td>
              
          
          <td>
            ".$row['user']."
          </td>
              
          
          <td>
            ".($all_speed)."Kb/s
          </td>
              
          
          <td>
            ".$row['ip4']."
          </td>
               
          
          <td>
            ".$row['interface']."
          </td>
               
          
          <td>
            ".($row['speed_car_in']/1024)."Kbits / ".($row['speed_car_out']/1024)."Kbits 
          </td>
              
          
          <td>
            all: ".($all)."Mb/ in:".$in."Mb /out:".$out."Mb
          </td>
              
          
          <td>
            ".$in_speed."Kb/s
          </td>
              
          
          <td>
            ".$out_speed."Kb/s
          </td>
              
          
          <td>
            ".$in_load."
          </td>
              
          
          <td>
            ".$out_load."
          </td>
            </tr>";
          }
          }
          echo $str1;
          echo $str;
          echo "
          
          <tr>
            <td>
              Итог:
            </td>
                    
            
            <td>
              
            </td>
                    
            
            <td>
              ".($all_speed_sum)."Kb/s
            </td>
                    
            
            <td>
              ip
            </td>
                    
            
            <td>
              interface
            </td>
                    
            
            <td>
              all: ".($all_sum)."Mb/ in:".$in_sum."Mb /out:".$out_sum."Mb
            </td>
                    
            
            <td>
              
            </td>
                     
            
            <td>
              ".$in_speed_sum."Kb/s
            </td>
                     
            
            <td>
              ".$out_speed_sum."Kb/s
            </td>
                     
            
            <td>
              ".$in_load_sum."
            </td>
            
            <td>
              ".$out_load_sum."
            </td>
                      
          </tr>";
          
          echo "</table>";
          mysql_close($link);
          ?>
          
          
          
          <?

?>
          </CENTER>
          
          
          <?
include("bottom.php");
?>
          
          </pre>