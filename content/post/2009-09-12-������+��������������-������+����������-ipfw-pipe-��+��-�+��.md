---
title: Автоматическое формирование ipfw pipe для правильного link-up
author: wel
type: post
date: 2009-09-11T23:01:59+00:00
url: /billing/автоматическое-формирование-ipfw-pipe-для-пр
short-url:
  - http://bit.ly/g8yHaK
wp-syntax-cache-content:
  - |
    a:2:{i:1;s:29447:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    36
    37
    38
    39
    40
    41
    42
    43
    44
    45
    46
    47
    48
    49
    50
    51
    52
    53
    54
    55
    56
    57
    58
    59
    60
    61
    62
    63
    64
    65
    66
    67
    68
    69
    70
    71
    72
    73
    74
    75
    76
    77
    78
    79
    80
    81
    82
    83
    84
    85
    86
    87
    88
    89
    90
    91
    92
    93
    94
    95
    96
    97
    98
    99
    100
    101
    102
    103
    104
    105
    106
    107
    108
    109
    110
    111
    112
    113
    114
    115
    116
    117
    118
    119
    120
    121
    122
    123
    124
    125
    126
    127
    128
    129
    130
    131
    132
    133
    134
    135
    136
    137
    138
    139
    140
    141
    142
    143
    144
    145
    146
    147
    148
    149
    150
    151
    152
    153
    154
    155
    </pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #339900;">#include &lt;QtCore&gt;</span>
    <span style="color: #339900;">#include &lt;QCoreApplication&gt;</span>
    <span style="color: #339900;">#include &lt;QtSql&gt;</span>
    <span style="color: #339900;">#include &lt;iostream&gt;</span>
    <span style="color: #339900;">#include &lt;cstdlib&gt;</span>
    <span style="color: #339900;">#include &lt;iomanip&gt;</span>
    <span style="color: #339900;">#include &lt;stdio.h&gt;</span>
    <span style="color: #339900;">#include &lt;stdlib.h&gt;</span>
    <span style="color: #339900;">#include &lt;string.h&gt;</span>
    <span style="color: #339900;">#include &lt;time.h&gt;</span>
    <span style="color: #0000ff;">using</span> <span style="color: #0000ff;">namespace</span> std<span style="color: #008080;">;</span>
    &nbsp;
    &nbsp;
    <span style="color: #339900;">#define SQLDRIVER &quot;QMYSQL&quot;</span>
    <span style="color: #339900;">#define HOST &quot;10.1.1.1&quot;</span>
    <span style="color: #339900;">#define DBNAME &quot;bezlim&quot;</span>
    <span style="color: #339900;">#define USER &quot;bezlim&quot;</span>
    <span style="color: #339900;">#define PASSWORD &quot;bezlim&quot;</span>
    &nbsp;
    <span style="color: #0000ff;">int</span> main<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>argv<span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        QCoreApplication a<span style="color: #008000;">&#40;</span>argc, argv<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
        QTextCodec <span style="color: #000040;">*</span>codec <span style="color: #000080;">=</span> QTextCodec<span style="color: #008080;">::</span><span style="color: #007788;">codecForName</span><span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;CP1251&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        QTextCodec<span style="color: #008080;">::</span><span style="color: #007788;">setCodecForTr</span><span style="color: #008000;">&#40;</span>codec<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        QTextCodec<span style="color: #008080;">::</span><span style="color: #007788;">setCodecForCStrings</span><span style="color: #008000;">&#40;</span>codec<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
        QSqlDatabase db <span style="color: #000080;">=</span> QSqlDatabase<span style="color: #008080;">::</span><span style="color: #007788;">addDatabase</span><span style="color: #008000;">&#40;</span>SQLDRIVER<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
        <span style="color: #0000ff;">if</span><span style="color: #008000;">&#40;</span> <span style="color: #000040;">!</span>db.<span style="color: #007788;">isDriverAvailable</span><span style="color: #008000;">&#40;</span>SQLDRIVER<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
        <span style="color: #008000;">&#123;</span>
    &nbsp;
        <span style="color: #008000;">&#125;</span>
    &nbsp;
    &nbsp;
        db.<span style="color: #007788;">setHostName</span><span style="color: #008000;">&#40;</span>HOST<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        db.<span style="color: #007788;">setDatabaseName</span><span style="color: #008000;">&#40;</span>DBNAME<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        db.<span style="color: #007788;">setUserName</span><span style="color: #008000;">&#40;</span>USER<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        db.<span style="color: #007788;">setPassword</span><span style="color: #008000;">&#40;</span>PASSWORD<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        <span style="color: #666666;">//db.setPort(3306);</span>
        <span style="color: #0000ff;">bool</span> ok<span style="color: #000080;">=</span>db.<span style="color: #007788;">open</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        <span style="color: #0000ff;">if</span><span style="color: #008000;">&#40;</span>ok<span style="color: #000040;">!</span><span style="color: #000080;">=</span><span style="color: #0000ff;">true</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span>
            std<span style="color: #008080;">::</span><span style="color: #0000dd;">cout</span><span style="color: #000080;">&lt;&lt;</span><span style="color: #FF0000;">&quot;unable connec't&quot;</span><span style="color: #008080;">;</span>
            <span style="color: #0000dd;">exit</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
        <span style="color: #008000;">&#125;</span>
         QString exec_this<span style="color: #008080;">;</span>
    <span style="color: #666666;">//     int bw1;</span>
    &nbsp;
         QString ip_argv<span style="color: #008080;">;</span>
         ip_argv<span style="color: #000080;">=</span>argv<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: #008000;">&#93;</span><span style="color: #008080;">;</span>
    &nbsp;
         <span style="color: #666666;">//qDebug()&lt;&lt;ip_argv;</span>
    &nbsp;
                qint64 num <span style="color: #000080;">=</span> <span style="color: #0000dd;">0</span><span style="color: #008080;">;</span>
                QString num1<span style="color: #008080;">;</span>
    &nbsp;
            QSqlQuery query<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;SELECT * FROM `freenibs`.`pipes` &quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
            <span style="color: #0000ff;">while</span> <span style="color: #008000;">&#40;</span>query.<span style="color: #007788;">next</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
            <span style="color: #008000;">&#123;</span>
                        num <span style="color: #000080;">=</span> query.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toInt</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        num1 <span style="color: #000080;">=</span> query.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        QString bw2 <span style="color: #000080;">=</span> query.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">2</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                <span style="color: #666666;">//query.clear();</span>
                    <span style="color: #0000ff;">if</span><span style="color: #008000;">&#40;</span>num<span style="color: #000080;">&gt;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span>
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw table &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; flush &quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
                        <span style="color: #666666;">//qDebug()&lt;&lt;&quot;NUM&gt;0|&quot;&lt;&lt;num1&lt;&lt;&quot;|&quot;&lt;&lt;endl;</span>
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw pipe &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; config mask dst-ip 0x000000ff bw &quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//exec_this +=&quot; config mask dst-ip 0xffffffff bw &quot;;</span>
    &nbsp;
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>bw2<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;Kbit/s&quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw pipe 10&quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; config mask src-ip 0x000000ff bw &quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//exec_this +=&quot; config mask src-ip 0xffffffff bw &quot;;</span>
    &nbsp;
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>bw2<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;Kbit/s&quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw delete &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw delete 10&quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw -q add &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; pipe &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; all from not 10.0.0.0/8 to table<span style="color: #000099; font-weight: bold;">\\</span>(&quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;<span style="color: #000099; font-weight: bold;">\\</span>) in &quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw -q add &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; pipe 10&quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; all from table<span style="color: #000099; font-weight: bold;">\\</span>(&quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>num1<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;<span style="color: #000099; font-weight: bold;">\\</span>) to not 10.0.0.0/8 out&quot;</span><span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
                    <span style="color: #008000;">&#125;</span>
                <span style="color: #008000;">&#125;</span>
    &nbsp;
    &nbsp;
    &nbsp;
                 QSqlQuery query1<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;SELECT `freenibs`.`pipes`.`n` ,`bezlim`.`all`.`ip` FROM `bezlim`.`all` LEFT JOIN   `freenibs`.`users` ON (`freenibs`.`users`.`framed_ip`=`bezlim`.`all`.`ip`) LEFT JOIN   `freenibs`.`pipes` ON (`freenibs`.`pipes`.`bw`=`bezlim`.`all`.`bw1` AND `freenibs`.`pipes`.`bw`&gt;0) WHERE `bezlim`.`all`.`bw1`&gt;0 AND `bezlim`.`all`.`ip` not LIKE 'deny.%'&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                 <span style="color: #0000ff;">while</span> <span style="color: #008000;">&#40;</span>query1.<span style="color: #007788;">next</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                         QString nums <span style="color: #000080;">=</span> query1.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                         qint64 numi <span style="color: #000080;">=</span> query1.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toInt</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                         QString ips <span style="color: #000080;">=</span> query1.<span style="color: #007788;">value</span><span style="color: #008000;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">toString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    &nbsp;
                <span style="color: #0000ff;">if</span><span style="color: #008000;">&#40;</span>numi<span style="color: #000080;">&gt;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;&quot;NUM&gt;0|&quot;&lt;&lt;num1&lt;&lt;&quot;|&quot;&lt;&lt;endl;</span>
                        <span style="color: #ff0000; font-style: italic;">/*exec_this =&quot;/sbin/ipfw pipe &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; config mask dst-ip 0x000000ff bw &quot;;
                        exec_this +=bw2;
                        exec_this +=&quot;Kbit/s&quot;;
                        */</span>
                        <span style="color: #666666;">//system(exec_this.toStdString().c_str());</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
                        exec_this <span style="color: #000080;">=</span><span style="color: #FF0000;">&quot;/sbin/ipfw table &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>nums<span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span><span style="color: #FF0000;">&quot; add &quot;</span><span style="color: #008080;">;</span>
                        exec_this <span style="color: #000040;">+</span><span style="color: #000080;">=</span>ips<span style="color: #008080;">;</span>
                        <span style="color: #0000dd;">system</span><span style="color: #008000;">&#40;</span>exec_this.<span style="color: #007788;">toStdString</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">c_str</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
                        <span style="color: #666666;">//qDebug()&lt;&lt;nums&lt;&lt;&quot;  &quot;&lt;&lt;ips&lt;&lt;endl&lt;&lt;exec_this&lt;&lt;endl;</span>
    &nbsp;
            <span style="color: #008000;">&#125;</span>
           <span style="color: #008000;">&#125;</span>
            <span style="color: #666666;">//qDebug()&lt;&lt;query1.lastError()&lt;&lt;endl;</span>
                query1.<span style="color: #007788;">clear</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
         db.<span style="color: #007788;">close</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
    <span style="color: #008000;">&#125;</span></pre></td></tr></table><p class="theCode" style="display:none;">#include &lt;QtCore&gt;
    #include &lt;QCoreApplication&gt;
    #include &lt;QtSql&gt;
    #include &lt;iostream&gt;
    #include &lt;cstdlib&gt;
    #include &lt;iomanip&gt;
    #include &lt;stdio.h&gt;
    #include &lt;stdlib.h&gt;
    #include &lt;string.h&gt;
    #include &lt;time.h&gt;
    using namespace std;
    
    
    #define SQLDRIVER &quot;QMYSQL&quot;
    #define HOST &quot;10.1.1.1&quot;
    #define DBNAME &quot;bezlim&quot;
    #define USER &quot;bezlim&quot;
    #define PASSWORD &quot;bezlim&quot;
    
    int main(int argc, char *argv[])
    {
        QCoreApplication a(argc, argv);
    
        QTextCodec *codec = QTextCodec::codecForName(&quot;CP1251&quot;);
        QTextCodec::setCodecForTr(codec);
        QTextCodec::setCodecForCStrings(codec);
    
        QSqlDatabase db = QSqlDatabase::addDatabase(SQLDRIVER);
    
        if( !db.isDriverAvailable(SQLDRIVER))
        {
    
        }
    
    
        db.setHostName(HOST);
        db.setDatabaseName(DBNAME);
        db.setUserName(USER);
        db.setPassword(PASSWORD);
        //db.setPort(3306);
        bool ok=db.open();
        if(ok!=true){
            std::cout&lt;&lt;&quot;unable connec't&quot;;
            exit(1);
        }
         QString exec_this;
    //     int bw1;
    
         QString ip_argv;
         ip_argv=argv[4];
    
         //qDebug()&lt;&lt;ip_argv;
    
                qint64 num = 0;
                QString num1;
    
            QSqlQuery query(&quot;SELECT * FROM `freenibs`.`pipes` &quot;);
            while (query.next())
            {
                        num = query.value(1).toInt();
                        num1 = query.value(1).toString();
                        QString bw2 = query.value(2).toString();
                //query.clear();
                    if(num&gt;0){
                        exec_this =&quot;/sbin/ipfw table &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; flush &quot;;
                        system(exec_this.toStdString().c_str());
    
                        //qDebug()&lt;&lt;&quot;NUM&gt;0|&quot;&lt;&lt;num1&lt;&lt;&quot;|&quot;&lt;&lt;endl;
                        exec_this =&quot;/sbin/ipfw pipe &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; config mask dst-ip 0x000000ff bw &quot;;
                        //exec_this +=&quot; config mask dst-ip 0xffffffff bw &quot;;
    
                        exec_this +=bw2;
                        exec_this +=&quot;Kbit/s&quot;;
                        system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;exec_this&lt;&lt;endl;
    
                        exec_this =&quot;/sbin/ipfw pipe 10&quot;;
                        exec_this +=num1;
                        exec_this +=&quot; config mask src-ip 0x000000ff bw &quot;;
                        //exec_this +=&quot; config mask src-ip 0xffffffff bw &quot;;
    
                        exec_this +=bw2;
                        exec_this +=&quot;Kbit/s&quot;;
                        system(exec_this.toStdString().c_str());
    
    
                        exec_this =&quot;/sbin/ipfw delete &quot;;
                        exec_this +=num1;
                        system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;exec_this&lt;&lt;endl;
    
                        exec_this =&quot;/sbin/ipfw delete 10&quot;;
                        exec_this +=num1;
                        system(exec_this.toStdString().c_str());
    
    
                        exec_this =&quot;/sbin/ipfw -q add &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; pipe &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; all from not 10.0.0.0/8 to table\\(&quot;;
                        exec_this +=num1;
                        exec_this +=&quot;\\) in &quot;;
                        system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;exec_this&lt;&lt;endl;
    
                        exec_this =&quot;/sbin/ipfw -q add &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; pipe 10&quot;;
                        exec_this +=num1;
                        exec_this +=&quot; all from table\\(&quot;;
                        exec_this +=num1;
                        exec_this +=&quot;\\) to not 10.0.0.0/8 out&quot;;
                        system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;exec_this&lt;&lt;endl;
    
                    }
                }
    
    
    
                 QSqlQuery query1(&quot;SELECT `freenibs`.`pipes`.`n` ,`bezlim`.`all`.`ip` FROM `bezlim`.`all` LEFT JOIN   `freenibs`.`users` ON (`freenibs`.`users`.`framed_ip`=`bezlim`.`all`.`ip`) LEFT JOIN   `freenibs`.`pipes` ON (`freenibs`.`pipes`.`bw`=`bezlim`.`all`.`bw1` AND `freenibs`.`pipes`.`bw`&gt;0) WHERE `bezlim`.`all`.`bw1`&gt;0 AND `bezlim`.`all`.`ip` not LIKE 'deny.%'&quot;);
                 while (query1.next()) {
                         QString nums = query1.value(0).toString();
                         qint64 numi = query1.value(0).toInt();
                         QString ips = query1.value(1).toString();
    
                if(numi&gt;0) {
                        //qDebug()&lt;&lt;&quot;NUM&gt;0|&quot;&lt;&lt;num1&lt;&lt;&quot;|&quot;&lt;&lt;endl;
                        /*exec_this =&quot;/sbin/ipfw pipe &quot;;
                        exec_this +=num1;
                        exec_this +=&quot; config mask dst-ip 0x000000ff bw &quot;;
                        exec_this +=bw2;
                        exec_this +=&quot;Kbit/s&quot;;
                        */
                        //system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;exec_this&lt;&lt;endl;
    
                        exec_this =&quot;/sbin/ipfw table &quot;;
                        exec_this +=nums;
                        exec_this +=&quot; add &quot;;
                        exec_this +=ips;
                        system(exec_this.toStdString().c_str());
                        //qDebug()&lt;&lt;nums&lt;&lt;&quot;  &quot;&lt;&lt;ips&lt;&lt;endl&lt;&lt;exec_this&lt;&lt;endl;
    
            }
           }
            //qDebug()&lt;&lt;query1.lastError()&lt;&lt;endl;
                query1.clear();
         db.close();
    }</p></div>
    ";i:2;s:46287:"
    <div class="wp_syntax" style="position:relative;"><table><tr><td class="line_numbers"><pre>1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
    12
    13
    14
    15
    16
    17
    18
    19
    20
    21
    22
    23
    24
    25
    26
    27
    28
    29
    30
    31
    32
    33
    34
    35
    36
    37
    38
    39
    40
    41
    42
    43
    44
    45
    46
    47
    48
    49
    50
    51
    52
    53
    54
    55
    56
    57
    58
    59
    60
    61
    62
    63
    64
    65
    66
    67
    68
    69
    70
    71
    72
    73
    74
    75
    76
    77
    78
    79
    80
    81
    82
    83
    84
    85
    86
    87
    88
    89
    90
    91
    92
    93
    94
    95
    96
    97
    98
    99
    100
    101
    102
    103
    104
    105
    106
    107
    108
    109
    110
    111
    112
    113
    114
    115
    116
    117
    118
    119
    120
    121
    122
    123
    124
    125
    126
    127
    128
    129
    130
    131
    </pre></td><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">-- phpMyAdmin SQL Dump</span>
    <span style="color: #808080; font-style: italic;">-- version 3.1.2</span>
    <span style="color: #808080; font-style: italic;">-- http://www.phpmyadmin.net</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">SET</span> SQL_MODE<span style="color: #66cc66;">=</span><span style="color: #ff0000;">&quot;NO_AUTO_VALUE_ON_ZERO&quot;</span>;
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- База данных: `freenibs`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">-- --------------------------------------------------------</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- Структура таблицы `pipes`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`pipes`</span>;
    <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`pipes`</span> <span style="color: #66cc66;">&#40;</span>
      <span style="color: #ff0000;">`id`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`n`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'11'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`bw`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span>  <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">UNIQUE</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #ff0000;">`bw`</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`bw`</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #66cc66;">&#41;</span> ENGINE<span style="color: #66cc66;">=</span>MyISAM  <span style="color: #993333; font-weight: bold;">DEFAULT</span> CHARSET<span style="color: #66cc66;">=</span>utf8 <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">63</span> ;
    &nbsp;
    &nbsp;
    <span style="color: #808080; font-style: italic;">-- --------------------------------------------------------</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- Структура таблицы `users`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`users`</span> <span style="color: #66cc66;">&#40;</span>
      <span style="color: #ff0000;">`user`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">CHARACTER</span> <span style="color: #993333; font-weight: bold;">SET</span> latin1 <span style="color: #993333; font-weight: bold;">COLLATE</span> latin1_bin <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`password`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">254</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">CHARACTER</span> <span style="color: #993333; font-weight: bold;">SET</span> latin1 <span style="color: #993333; font-weight: bold;">COLLATE</span> latin1_bin <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'*'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`crypt_method`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UNSIGNED</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'1'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`uid`</span> <span style="color: #993333; font-weight: bold;">SMALLINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UNSIGNED</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`gid`</span> <span style="color: #993333; font-weight: bold;">SMALLINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UNSIGNED</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'1'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`deposit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">2</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0.00'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`credit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">2</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0.00'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`fio`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`name`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`second_name`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`otch`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`phone`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`address`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">128</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`prim`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">254</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`add_date`</span> <span style="color: #993333; font-weight: bold;">DATE</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0000-00-00'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`tos`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`do_with_tos`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`direction`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`fixed`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`fixed_cost`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">6</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`activation_time`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_time_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`month_time_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`week_time_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`day_time_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_traffic_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`month_traffic_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`week_traffic_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`day_traffic_limit`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_money_limit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">6</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`month_money_limit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">6</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`week_money_limit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">6</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`day_money_limit`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">6</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`login_time`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">254</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`huntgroup_name`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`simultaneous_use`</span> <span style="color: #993333; font-weight: bold;">SMALLINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`port_limit`</span> <span style="color: #993333; font-weight: bold;">SMALLINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`session_timeout`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`idle_timeout`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`allowed_prefixes`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`no_pass`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`no_acct`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`allow_callback`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`other_params`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">254</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`allowed_servers`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">254</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`blocked`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UNSIGNED</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`activated`</span> tinyint<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UNSIGNED</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'1'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`expired`</span> <span style="color: #993333; font-weight: bold;">DATE</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0000-00-00'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_time`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_traffic`</span> <span style="color: #993333; font-weight: bold;">BIGINT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`total_money`</span> <span style="color: #993333; font-weight: bold;">DOUBLE</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0.0000'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`last_connection`</span> <span style="color: #993333; font-weight: bold;">DATE</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0000-00-00'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`framed_ip`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`frammed_ip2`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`local_addr`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`framed_mask`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">16</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'255.255.255.255'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`callback_number`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">''</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`street`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`house`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`room`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">64</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`bezabon`</span> enum<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'no'</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'yes'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'no'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`segment`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">255</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`mac_addr`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">17</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`updown`</span> <span style="color: #993333; font-weight: bold;">SET</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'down'</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'up'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'down'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`up_n`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">11</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`fix`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">2</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`vlan_for_fix`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">25</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'vlan4'</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span>  <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`uid`</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #ff0000;">`user`</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`user`</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #66cc66;">&#41;</span> ENGINE<span style="color: #66cc66;">=</span>MyISAM  <span style="color: #993333; font-weight: bold;">DEFAULT</span> CHARSET<span style="color: #66cc66;">=</span>latin1 <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1043</span> ;
    &nbsp;
    &nbsp;
    &nbsp;
    &nbsp;
    &nbsp;
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- База данных: `bezlim`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">-- --------------------------------------------------------</span>
    &nbsp;
    <span style="color: #808080; font-style: italic;">--</span>
    <span style="color: #808080; font-style: italic;">-- Структура таблицы `all`</span>
    <span style="color: #808080; font-style: italic;">--</span>
    &nbsp;
    <span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`all`</span>;
    <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">EXISTS</span> <span style="color: #ff0000;">`all`</span> <span style="color: #66cc66;">&#40;</span>
      <span style="color: #ff0000;">`ip`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">48</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'192.168.0.1'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`rule`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">32</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'500'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`bw1`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`bw2`</span> <span style="color: #993333; font-weight: bold;">VARCHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'0'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`activ`</span> <span style="color: #993333; font-weight: bold;">CHAR</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">DEFAULT</span> <span style="color: #ff0000;">'y'</span><span style="color: #66cc66;">,</span>
      <span style="color: #ff0000;">`id`</span> <span style="color: #993333; font-weight: bold;">INT</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">32</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span>  <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
      <span style="color: #993333; font-weight: bold;">UNIQUE</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #ff0000;">`ip`</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`ip`</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #66cc66;">&#41;</span> ENGINE<span style="color: #66cc66;">=</span>MyISAM  <span style="color: #993333; font-weight: bold;">DEFAULT</span> CHARSET<span style="color: #66cc66;">=</span>latin1 <span style="color: #993333; font-weight: bold;">AUTO_INCREMENT</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">3326</span> ;</pre></td></tr></table><p class="theCode" style="display:none;">-- phpMyAdmin SQL Dump
    -- version 3.1.2
    -- http://www.phpmyadmin.net
    --
    
    SET SQL_MODE=&quot;NO_AUTO_VALUE_ON_ZERO&quot;;
    
    --
    -- База данных: `freenibs`
    --
    
    -- --------------------------------------------------------
    
    --
    -- Структура таблицы `pipes`
    --
    
    DROP TABLE IF EXISTS `pipes`;
    CREATE TABLE IF NOT EXISTS `pipes` (
      `id` int(255) NOT NULL auto_increment,
      `n` int(255) NOT NULL default '11',
      `bw` int(255) default '0',
      PRIMARY KEY  (`id`),
      UNIQUE KEY `bw` (`bw`)
    ) ENGINE=MyISAM  DEFAULT CHARSET=utf8 AUTO_INCREMENT=63 ;
    
    
    -- --------------------------------------------------------
    
    --
    -- Структура таблицы `users`
    --
    
    CREATE TABLE IF NOT EXISTS `users` (
      `user` varchar(64) character set latin1 collate latin1_bin NOT NULL default '',
      `password` varchar(254) character set latin1 collate latin1_bin NOT NULL default '*',
      `crypt_method` tinyint(1) unsigned NOT NULL default '1',
      `uid` smallint(5) unsigned NOT NULL auto_increment,
      `gid` smallint(5) unsigned NOT NULL default '1',
      `deposit` double(8,2) NOT NULL default '0.00',
      `credit` double(8,2) NOT NULL default '0.00',
      `fio` varchar(128) NOT NULL default '',
      `name` varchar(128) default NULL,
      `second_name` varchar(128) default NULL,
      `otch` varchar(128) default NULL,
      `phone` varchar(128) NOT NULL default '',
      `address` varchar(128) NOT NULL default '',
      `prim` varchar(254) NOT NULL default '',
      `add_date` date NOT NULL default '0000-00-00',
      `tos` tinyint(1) default NULL,
      `do_with_tos` tinyint(1) default NULL,
      `direction` tinyint(1) default NULL,
      `fixed` tinyint(1) default NULL,
      `fixed_cost` double(16,6) default NULL,
      `activation_time` bigint(15) default NULL,
      `total_time_limit` bigint(15) default NULL,
      `month_time_limit` bigint(15) default NULL,
      `week_time_limit` bigint(15) default NULL,
      `day_time_limit` bigint(15) default NULL,
      `total_traffic_limit` bigint(15) default NULL,
      `month_traffic_limit` bigint(15) default NULL,
      `week_traffic_limit` bigint(15) default NULL,
      `day_traffic_limit` bigint(15) default NULL,
      `total_money_limit` double(16,6) default NULL,
      `month_money_limit` double(16,6) default NULL,
      `week_money_limit` double(16,6) default NULL,
      `day_money_limit` double(16,6) default NULL,
      `login_time` varchar(254) default NULL,
      `huntgroup_name` varchar(64) default NULL,
      `simultaneous_use` smallint(5) default NULL,
      `port_limit` smallint(5) default NULL,
      `session_timeout` bigint(15) default NULL,
      `idle_timeout` bigint(15) default NULL,
      `allowed_prefixes` varchar(64) default NULL,
      `no_pass` tinyint(1) default NULL,
      `no_acct` tinyint(1) default NULL,
      `allow_callback` tinyint(1) default NULL,
      `other_params` varchar(254) default NULL,
      `allowed_servers` varchar(254) default NULL,
      `blocked` tinyint(3) unsigned NOT NULL default '0',
      `activated` tinyint(3) unsigned NOT NULL default '1',
      `expired` date NOT NULL default '0000-00-00',
      `total_time` int(10) NOT NULL default '0',
      `total_traffic` bigint(15) NOT NULL default '0',
      `total_money` double(10,4) NOT NULL default '0.0000',
      `last_connection` date NOT NULL default '0000-00-00',
      `framed_ip` varchar(16) NOT NULL default '',
      `frammed_ip2` varchar(16) NOT NULL,
      `local_addr` varchar(16) NOT NULL,
      `framed_mask` varchar(16) NOT NULL default '255.255.255.255',
      `callback_number` varchar(64) NOT NULL default '',
      `street` varchar(255) NOT NULL,
      `house` varchar(64) NOT NULL,
      `room` varchar(64) NOT NULL,
      `bezabon` enum('no','yes') NOT NULL default 'no',
      `segment` varchar(255) NOT NULL,
      `mac_addr` varchar(17) NOT NULL,
      `updown` set('down','up') NOT NULL default 'down',
      `up_n` int(11) NOT NULL default '0',
      `fix` int(2) NOT NULL default '0',
      `vlan_for_fix` varchar(25) NOT NULL default 'vlan4',
      PRIMARY KEY  (`uid`),
      KEY `user` (`user`)
    ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1043 ;
    
    
    
    
    
    
    --
    -- База данных: `bezlim`
    --
    
    -- --------------------------------------------------------
    
    --
    -- Структура таблицы `all`
    --
    
    DROP TABLE IF EXISTS `all`;
    CREATE TABLE IF NOT EXISTS `all` (
      `ip` varchar(48) NOT NULL default '192.168.0.1',
      `rule` int(32) NOT NULL default '500',
      `bw1` varchar(12) NOT NULL default '0',
      `bw2` varchar(12) NOT NULL default '0',
      `activ` char(1) NOT NULL default 'y',
      `id` int(32) NOT NULL auto_increment,
      PRIMARY KEY  (`id`),
      UNIQUE KEY `ip` (`ip`)
    ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3326 ;</p></div>
    ";}
categories:
  - billing
  - дополнения

---
Что делает этот скрипт?
  
Допустим у Нас есть сервер и пользователи с фейковыми адресами. Мы используем скрипт [link-up][1] при подключении пользователя. Юзер отлично подключился, пользуется Интернетом &#8212; отключился. Но у нас некая ошибка или изменение &#8212; Мы другому пользователю выдаём этот же ИП-к. Тогда у Нас могут возникнуть проблемы с тем, что скорость не правильно регулируется. 

Этот скрипт раз в х-минут по крону или вашему желанию восстанавливает справедливое положение вещей)))
  
Можно так же добавить сюда очистку для тех, кто не в онлайне)))

Так же Он создаёт правильные pip&#8217;ы, которых не было &#8212; избавляя Вас от надобности apache&#8217;у давать sudo, как это сделано в freeNIBS.

но будьте осторожны Я встречал сообщения о том, что если выполнять очень быстро (у Меня 2000 раз например) команды ipfw могут быть траблы.

<!--more-->


  
main.cpp:

<pre lang="cpp" line="1">#include &lt;QtCore>
#include &lt;QCoreApplication>
#include &lt;QtSql>
#include &lt;iostream>
#include &lt;cstdlib>
#include &lt;iomanip>
#include &lt;stdio.h>
#include &lt;stdlib.h>
#include &lt;string.h>
#include &lt;time.h>
using namespace std;


#define SQLDRIVER "QMYSQL"
#define HOST "10.1.1.1"
#define DBNAME "bezlim"
#define USER "bezlim"
#define PASSWORD "bezlim"

int main(int argc, char *argv[])
{
    QCoreApplication a(argc, argv);

    QTextCodec *codec = QTextCodec::codecForName("CP1251");
    QTextCodec::setCodecForTr(codec);
    QTextCodec::setCodecForCStrings(codec);

    QSqlDatabase db = QSqlDatabase::addDatabase(SQLDRIVER);

    if( !db.isDriverAvailable(SQLDRIVER))
    {

    }


    db.setHostName(HOST);
    db.setDatabaseName(DBNAME);
    db.setUserName(USER);
    db.setPassword(PASSWORD);
    //db.setPort(3306);
    bool ok=db.open();
    if(ok!=true){
        std::cout&lt;&lt;"unable connec't";
        exit(1);
    }
     QString exec_this;
//     int bw1;

     QString ip_argv;
     ip_argv=argv[4];

     //qDebug()&lt;&lt;ip_argv;

            qint64 num = 0;
            QString num1;

        QSqlQuery query("SELECT * FROM `freenibs`.`pipes` ");
        while (query.next())
        {
                    num = query.value(1).toInt();
                    num1 = query.value(1).toString();
                    QString bw2 = query.value(2).toString();
            //query.clear();
                if(num>0){
                    exec_this ="/sbin/ipfw table ";
                    exec_this +=num1;
                    exec_this +=" flush ";
                    system(exec_this.toStdString().c_str());

                    //qDebug()&lt;&lt;"NUM>0|"&lt;&lt;num1&lt;&lt;"|"&lt;&lt;endl;
                    exec_this ="/sbin/ipfw pipe ";
                    exec_this +=num1;
                    exec_this +=" config mask dst-ip 0x000000ff bw ";
                    //exec_this +=" config mask dst-ip 0xffffffff bw ";

                    exec_this +=bw2;
                    exec_this +="Kbit/s";
                    system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;exec_this&lt;&lt;endl;

                    exec_this ="/sbin/ipfw pipe 10";
                    exec_this +=num1;
                    exec_this +=" config mask src-ip 0x000000ff bw ";
                    //exec_this +=" config mask src-ip 0xffffffff bw ";

                    exec_this +=bw2;
                    exec_this +="Kbit/s";
                    system(exec_this.toStdString().c_str());


                    exec_this ="/sbin/ipfw delete ";
                    exec_this +=num1;
                    system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;exec_this&lt;&lt;endl;

                    exec_this ="/sbin/ipfw delete 10";
                    exec_this +=num1;
                    system(exec_this.toStdString().c_str());


                    exec_this ="/sbin/ipfw -q add ";
                    exec_this +=num1;
                    exec_this +=" pipe ";
                    exec_this +=num1;
                    exec_this +=" all from not 10.0.0.0/8 to table\\(";
                    exec_this +=num1;
                    exec_this +="\\) in ";
                    system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;exec_this&lt;&lt;endl;

                    exec_this ="/sbin/ipfw -q add ";
                    exec_this +=num1;
                    exec_this +=" pipe 10";
                    exec_this +=num1;
                    exec_this +=" all from table\\(";
                    exec_this +=num1;
                    exec_this +="\\) to not 10.0.0.0/8 out";
                    system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;exec_this&lt;&lt;endl;

                }
            }



             QSqlQuery query1("SELECT `freenibs`.`pipes`.`n` ,`bezlim`.`all`.`ip` FROM `bezlim`.`all` LEFT JOIN   `freenibs`.`users` ON (`freenibs`.`users`.`framed_ip`=`bezlim`.`all`.`ip`) LEFT JOIN   `freenibs`.`pipes` ON (`freenibs`.`pipes`.`bw`=`bezlim`.`all`.`bw1` AND `freenibs`.`pipes`.`bw`>0) WHERE `bezlim`.`all`.`bw1`>0 AND `bezlim`.`all`.`ip` not LIKE 'deny.%'");
             while (query1.next()) {
                     QString nums = query1.value(0).toString();
                     qint64 numi = query1.value(0).toInt();
                     QString ips = query1.value(1).toString();

            if(numi>0) {
                    //qDebug()&lt;&lt;"NUM>0|"&lt;&lt;num1&lt;&lt;"|"&lt;&lt;endl;
                    /*exec_this ="/sbin/ipfw pipe ";
                    exec_this +=num1;
                    exec_this +=" config mask dst-ip 0x000000ff bw ";
                    exec_this +=bw2;
                    exec_this +="Kbit/s";
                    */
                    //system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;exec_this&lt;&lt;endl;

                    exec_this ="/sbin/ipfw table ";
                    exec_this +=nums;
                    exec_this +=" add ";
                    exec_this +=ips;
                    system(exec_this.toStdString().c_str());
                    //qDebug()&lt;&lt;nums&lt;&lt;"  "&lt;&lt;ips&lt;&lt;endl&lt;&lt;exec_this&lt;&lt;endl;

        }
       }
        //qDebug()&lt;&lt;query1.lastError()&lt;&lt;endl;
            query1.clear();
     db.close();
}
</pre>

<pre lang="sql" line="1">-- phpMyAdmin SQL Dump
-- version 3.1.2
-- http://www.phpmyadmin.net
--

SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";

--
-- База данных: `freenibs`
--

-- --------------------------------------------------------

--
-- Структура таблицы `pipes`
--

DROP TABLE IF EXISTS `pipes`;
CREATE TABLE IF NOT EXISTS `pipes` (
  `id` int(255) NOT NULL auto_increment,
  `n` int(255) NOT NULL default '11',
  `bw` int(255) default '0',
  PRIMARY KEY  (`id`),
  UNIQUE KEY `bw` (`bw`)
) ENGINE=MyISAM  DEFAULT CHARSET=utf8 AUTO_INCREMENT=63 ;


-- --------------------------------------------------------

--
-- Структура таблицы `users`
--

CREATE TABLE IF NOT EXISTS `users` (
  `user` varchar(64) character set latin1 collate latin1_bin NOT NULL default '',
  `password` varchar(254) character set latin1 collate latin1_bin NOT NULL default '*',
  `crypt_method` tinyint(1) unsigned NOT NULL default '1',
  `uid` smallint(5) unsigned NOT NULL auto_increment,
  `gid` smallint(5) unsigned NOT NULL default '1',
  `deposit` double(8,2) NOT NULL default '0.00',
  `credit` double(8,2) NOT NULL default '0.00',
  `fio` varchar(128) NOT NULL default '',
  `name` varchar(128) default NULL,
  `second_name` varchar(128) default NULL,
  `otch` varchar(128) default NULL,
  `phone` varchar(128) NOT NULL default '',
  `address` varchar(128) NOT NULL default '',
  `prim` varchar(254) NOT NULL default '',
  `add_date` date NOT NULL default '0000-00-00',
  `tos` tinyint(1) default NULL,
  `do_with_tos` tinyint(1) default NULL,
  `direction` tinyint(1) default NULL,
  `fixed` tinyint(1) default NULL,
  `fixed_cost` double(16,6) default NULL,
  `activation_time` bigint(15) default NULL,
  `total_time_limit` bigint(15) default NULL,
  `month_time_limit` bigint(15) default NULL,
  `week_time_limit` bigint(15) default NULL,
  `day_time_limit` bigint(15) default NULL,
  `total_traffic_limit` bigint(15) default NULL,
  `month_traffic_limit` bigint(15) default NULL,
  `week_traffic_limit` bigint(15) default NULL,
  `day_traffic_limit` bigint(15) default NULL,
  `total_money_limit` double(16,6) default NULL,
  `month_money_limit` double(16,6) default NULL,
  `week_money_limit` double(16,6) default NULL,
  `day_money_limit` double(16,6) default NULL,
  `login_time` varchar(254) default NULL,
  `huntgroup_name` varchar(64) default NULL,
  `simultaneous_use` smallint(5) default NULL,
  `port_limit` smallint(5) default NULL,
  `session_timeout` bigint(15) default NULL,
  `idle_timeout` bigint(15) default NULL,
  `allowed_prefixes` varchar(64) default NULL,
  `no_pass` tinyint(1) default NULL,
  `no_acct` tinyint(1) default NULL,
  `allow_callback` tinyint(1) default NULL,
  `other_params` varchar(254) default NULL,
  `allowed_servers` varchar(254) default NULL,
  `blocked` tinyint(3) unsigned NOT NULL default '0',
  `activated` tinyint(3) unsigned NOT NULL default '1',
  `expired` date NOT NULL default '0000-00-00',
  `total_time` int(10) NOT NULL default '0',
  `total_traffic` bigint(15) NOT NULL default '0',
  `total_money` double(10,4) NOT NULL default '0.0000',
  `last_connection` date NOT NULL default '0000-00-00',
  `framed_ip` varchar(16) NOT NULL default '',
  `frammed_ip2` varchar(16) NOT NULL,
  `local_addr` varchar(16) NOT NULL,
  `framed_mask` varchar(16) NOT NULL default '255.255.255.255',
  `callback_number` varchar(64) NOT NULL default '',
  `street` varchar(255) NOT NULL,
  `house` varchar(64) NOT NULL,
  `room` varchar(64) NOT NULL,
  `bezabon` enum('no','yes') NOT NULL default 'no',
  `segment` varchar(255) NOT NULL,
  `mac_addr` varchar(17) NOT NULL,
  `updown` set('down','up') NOT NULL default 'down',
  `up_n` int(11) NOT NULL default '0',
  `fix` int(2) NOT NULL default '0',
  `vlan_for_fix` varchar(25) NOT NULL default 'vlan4',
  PRIMARY KEY  (`uid`),
  KEY `user` (`user`)
) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1043 ;






--
-- База данных: `bezlim`
--

-- --------------------------------------------------------

--
-- Структура таблицы `all`
--

DROP TABLE IF EXISTS `all`;
CREATE TABLE IF NOT EXISTS `all` (
  `ip` varchar(48) NOT NULL default '192.168.0.1',
  `rule` int(32) NOT NULL default '500',
  `bw1` varchar(12) NOT NULL default '0',
  `bw2` varchar(12) NOT NULL default '0',
  `activ` char(1) NOT NULL default 'y',
  `id` int(32) NOT NULL auto_increment,
  PRIMARY KEY  (`id`),
  UNIQUE KEY `ip` (`ip`)
) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=3326 ;


</pre>

 [1]: http://isp.pl.ua/?p=13